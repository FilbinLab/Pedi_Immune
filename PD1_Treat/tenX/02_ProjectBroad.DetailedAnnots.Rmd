---
title: "ProjectBroadAnnots.Rmd"
author: "Jenna LaBelle"
date: "10/07/22"
output: html_document
---

## Project "broad" (T cell and myeloid) and "detailed" (CD4, CD8, DC, Monocyte, Bcell) annotations from the full immune cohort to PD1 treated patients

```{r}
library(Seurat) 

base_dir = "/Users/jlabelle/"
script_dir = "Dropbox (Partners HealthCare)/FilbinLab/data_analysis/Scripts/"
working_dir<- paste0(base_dir, 
                     "Dropbox (Partners HealthCare)/FilbinLab/",
                     "data_analysis/Projects/git_repos/Pedi_Immune/PD1_Treat/tenX/")

analysis_dir<- paste0(working_dir, "/analysis/project_broad.detailed_annot/")
figure_dir<- paste0(working_dir, "/figures/project_broad.detailed_annot/")

if(!dir.exists(figure_dir)){dir.create(figure_dir, recursive = TRUE)}
if(!dir.exists(analysis_dir)){dir.create(analysis_dir, recursive = TRUE)}

preprocessing = paste0(base_dir, script_dir, "single_cell_preprocessing_helper_functions.R")
nmf_helper = paste0(base_dir, script_dir, "NMF_helper_function.R")
source(preprocessing)
source(nmf_helper)

```

## Load seurat objects: pd-1 (processed in 01b_Preprocess_QC_ToSeurat.Rmd) and full immune cohort (both myeloid and t cells)
```{r}
full_cohort_dir<- "../../ImmuneCellAnalysis/"

pd1_seurat<- readRDS( "analysis/preprocessing/seurat_obj_noAC.Unknown.Rds")
full_seurat<- readRDS(paste0(full_cohort_dir,
                             "01_Preprocessing/02_Counts_Preprocess/analysis/detailed_annotation/pedOnly_nomuv63/",
                             "tcell.myeloid_seurat_harmony.Rds"))
full_tcell_seurat<- readRDS(paste0(full_cohort_dir,
                                   "02a_Tcells/02_Ped.Adult/03_Visualize.Reannotate_programs/analysis/Reannotate_programs/",
                                   "rank8_sharedByunion/",
                                   "ped_seurat_tcell_harmony.Rds"))
full_myeloid_seurat<- readRDS(paste0(full_cohort_dir,
                                     "01_Preprocessing/02_Counts_Preprocess/analysis/detailed_annotation/",
                                     "pedOnly_nomuv63/",
                                     "myeloid_seurat_harmony.Rds"))

## Colors 
immune_colors<- readRDS(paste0(full_cohort_dir, "/plot_colors/ImmuneCell.celltypes.Rds"))

```


## Projection of myeloid/tcell annotations with pcproject 
```{r}
seurat_list<-list(full=full_seurat, pd1=pd1_seurat)

transferAnchors<-FindTransferAnchors(reference = seurat_list$full, query=seurat_list$pd1,
                                     reduction = "pcaproject")

predictions <- TransferData(anchorset = transferAnchors, 
                            refdata = full_seurat$broad_annot,
                            weight.reduction = "pcaproject")

predictions_final<- predictions$predicted.id; names(predictions_final)<- rownames(predictions)
pd1_seurat<- AddMetaData(pd1_seurat, predictions, col.name=c("broad_annot_projected", "Tcell_score_projected", 
                                                             "Myeloid_score_projected", "max_score_projected"))

## plot
DimPlot(pd1_seurat, group.by="broad_annot_projected", pt.size = 1, label=TRUE, label.size = 6)+ NoLegend()+
  scale_color_manual(values=immune_colors[names(immune_colors) %in% pd1_seurat$broad_annot_projected])
ggsave(paste0(figure_dir, "UMAP_broadAnnot_projectedFromFull.png"), width=6, height=6)

## Confirm high expression of myeloid/tcell markers by predicted broad annotation
cowplot::plot_grid(plotlist=lapply(c("CSF1R", "CD3G", "CD8A", "CD4"), function(x){
  VlnPlot(pd1_seurat, features=x, group.by = "broad_annot_projected")+ NoLegend()+
    scale_fill_manual(values=immune_colors[names(immune_colors) %in% pd1_seurat$broad_annot_projected])+
    xlab("")
}), ncol=4)
ggsave(paste0(figure_dir, "Vln_broadMarkers_projectedFromFull.png"), width=12, height=4)

## Proportion
df<- as.data.frame(table(pd1_seurat$broad_annot_projected))
colnames(df)<-c("CellType", "NCells")
df<- df %>% mutate(perCells=NCells/sum(NCells)) %>% as.data.frame()
ggplot(df, aes(x="", y=perCells, fill=CellType))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=immune_colors[names(immune_colors) %in% df$CellType])+
  theme_classic()+
  xlab("")
ggsave(paste0(figure_dir, "Breakdown_broadAnnot.png"), width=3, height=4)
âˆ‚
saveRDS(pd1_seurat, file="analysis/preprocessing/seurat_obj_noAC.Unknown.Rds")
```

## Split into myeloid/tcell seurat objects, rerun processing
```{r}
## Myeloid
myeloid_pd1<- subset(pd1_seurat, broad_annot_projected=="Myeloid")
myeloid_pd1_meta<- myeloid_pd1@meta.data
myeloid_pd1<- RunFullSeurat(myeloid_pd1@assays$RNA@counts, samples= myeloid_pd1$sample, RunHarmony = FALSE)
myeloid_pd1<- AddMetaData(myeloid_pd1, myeloid_pd1_meta[,!colnames(myeloid_pd1_meta) %in% colnames(myeloid_pd1@meta.data)])

## Tcell
tcell_pd1<- subset(pd1_seurat, broad_annot_projected=="Tcell")
tcell_pd1_meta<- tcell_pd1@meta.data
tcell_pd1<- RunFullSeurat(tcell_pd1@assays$RNA@counts, samples= tcell_pd1$sample, RunHarmony = FALSE)
tcell_pd1<- AddMetaData(tcell_pd1, tcell_pd1_meta[,!colnames(tcell_pd1_meta) %in% colnames(tcell_pd1@meta.data)])

saveRDS(myeloid_pd1, file=paste0(analysis_dir, "myeloid_pd1_seurat.Rds"))
saveRDS(tcell_pd1, file=paste0(analysis_dir, "tcell_pd1_seurat.Rds"))
```


## Projection of CD4/CD8 annotations for T cells with pcproject 
```{r}
tcell_pd1<- readRDS(paste0(analysis_dir, "tcell_pd1_seurat.Rds"))

full_tcell_seurat<- subset(full_tcell_seurat, detailed_annot_byNMFrank8_mergedByunion != "Unclear")
seurat_list<-list(full=full_tcell_seurat, pd1=tcell_pd1)

transferAnchors<-FindTransferAnchors(reference = seurat_list$full, query=seurat_list$pd1,
                                     reduction = "pcaproject")

predictions <- TransferData(anchorset = transferAnchors, 
                            refdata = full_tcell_seurat$detailed_annot_byNMFrank8_mergedByunion,
                            weight.reduction = "pcaproject")

predictions_final<- predictions$predicted.id; names(predictions_final)<- rownames(predictions)
tcell_pd1<- AddMetaData(tcell_pd1, predictions, col.name=c("detailed_annot_projected", "CD4_score_projected", 
                                                             "CD8_score_projected", "max_score_projected"))

## plot
DimPlot(tcell_pd1, group.by="detailed_annot_projected", pt.size = 1, label=TRUE, label.size = 6)+ NoLegend()+
  scale_color_manual(values=immune_colors[names(immune_colors) %in% tcell_pd1$detailed_annot_projected])
ggsave(paste0(figure_dir, "UMAP_Tcell_detailedAnnot_projectedFromFull.png"), width=6, height=6)

## Confirm high expression of tcell markers by predicted detailed annotation
cowplot::plot_grid(plotlist=lapply(c( "CD3G", "CD8A", "CD4"), function(x){
  VlnPlot(tcell_pd1, features=x, group.by = "detailed_annot_projected")+ NoLegend()+
    scale_fill_manual(values=immune_colors[names(immune_colors) %in% tcell_pd1$detailed_annot_projected])+
    xlab("")
}), ncol=3)
ggsave(paste0(figure_dir, "Vln_Tcell_detailedMarkers_projectedFromFull.png"), width=9, height=4)

## Save with annotations
saveRDS(tcell_pd1, file=paste0(analysis_dir, "tcell_pd1_seurat.Rds"))

## Split into cd4/cd8, recluster, save
cd4_pd1<- subset(tcell_pd1, detailed_annot_projected=="CD4")
cd4_pd1_meta<- cd4_pd1@meta.data
cd4_pd1<- RunFullSeurat(cd4_pd1@assays$RNA@counts, samples=cd4_pd1$sample, RunHarmony = FALSE)
cd4_pd1<- AddMetaData(cd4_pd1, cd4_pd1_meta[,!colnames(cd4_pd1_meta) %in% colnames(cd4_pd1@meta.data)])

cd8_pd1<- subset(tcell_pd1, detailed_annot_projected=="CD8")
cd8_pd1_meta<- cd8_pd1@meta.data
cd8_pd1<- RunFullSeurat(cd8_pd1@assays$RNA@counts, samples=cd8_pd1$sample, RunHarmony = FALSE)
cd8_pd1<- AddMetaData(cd8_pd1, cd8_pd1_meta[,!colnames(cd8_pd1_meta) %in% colnames(cd8_pd1@meta.data)])

saveRDS(cd4_pd1, file=paste0(analysis_dir, "cd4_pd1_seurat.Rds"))
saveRDS(cd8_pd1, file=paste0(analysis_dir, "cd8_pd1_seurat.Rds"))
```

## Projection of DC/BC/Monocyte annotations for myeloid cells with pcproject 
```{r}
myeloid_pd1<- readRDS(paste0(analysis_dir, "myeloid_pd1_seurat.Rds"))

seurat_list<-list(full=full_myeloid_seurat, pd1=myeloid_pd1)

transferAnchors<-FindTransferAnchors(reference = seurat_list$full, query=seurat_list$pd1,
                                     reduction = "pcaproject")

predictions <- TransferData(anchorset = transferAnchors, 
                            refdata = full_myeloid_seurat$detailed_annot,
                            weight.reduction = "pcaproject")

predictions_final<- predictions$predicted.id; names(predictions_final)<- rownames(predictions)
myeloid_pd1<- AddMetaData(myeloid_pd1, predictions, col.name=c("detailed_annot_projected", "Myeloid_score_projected", 
                                                             "Bcell_score_projected", "DC_score_projected", "max_score_projected"))

## plot
DimPlot(myeloid_pd1, group.by="detailed_annot_projected", pt.size = 1, label=TRUE, label.size = 6)+ NoLegend()+
  scale_color_manual(values=immune_colors[names(immune_colors) %in% myeloid_pd1$detailed_annot_projected])
ggsave(paste0(figure_dir, "UMAP_myeloid_detailedAnnot_projectedFromFull.png"), width=6, height=6)

## Confirm high expression of myeloid markers by predicted detailed annotation
cowplot::plot_grid(plotlist=lapply(c( "CSF1R",  "CD207", "MS4A1"), function(x){
  VlnPlot(myeloid_pd1, features=x, group.by = "detailed_annot_projected")+ NoLegend()+
    scale_fill_manual(values=immune_colors[names(immune_colors) %in% myeloid_pd1$detailed_annot_projected])+
    xlab("")
}), ncol=3)
ggsave(paste0(figure_dir, "Vln_myeloid_detailedMarkers_projectedFromFull.png"), width=9, height=4)

## Save with annotations
saveRDS(myeloid_pd1, file=paste0(analysis_dir, "myeloid_pd1_seurat.Rds"))

## Remove DC/BC, rerun clustering, and save
myeloid_pd1_noDC.B<- subset(myeloid_pd1, detailed_annot_projected == "Myeloid")
myeloid_pd1_noDC.B_meta<- myeloid_pd1_noDC.B@meta.data
myeloid_pd1_noDC.B<- RunFullSeurat(myeloid_pd1_noDC.B@assays$RNA@counts, RunHarmony = TRUE, samples=myeloid_pd1_noDC.B$sample)
myeloid_pd1_noDC.B<- AddMetaData(myeloid_pd1_noDC.B, myeloid_pd1_noDC.B_meta[,!colnames(myeloid_pd1_noDC.B_meta) %in% 
                                                                               colnames(myeloid_pd1_noDC.B@meta.data)])
saveRDS(myeloid_pd1_noDC.B, file=paste0(analysis_dir, "myeloid_pd1_noDC.B_seurat.Rds"))
```
