---
title: "ProjectBroadAnnots.Rmd"
author: "Jenna LaBelle"
date: "10/07/22"
output: html_document
---

## Score programs from the full immune cohort for the treated/10x samples

```{r}
library(Seurat) 

base_dir = "/Users/jlabelle/"
script_dir = "Dropbox (Partners HealthCare)/FilbinLab/data_analysis/Scripts/"
working_dir<- paste0(base_dir, 
                     "Dropbox (Partners HealthCare)/FilbinLab/",
                     "data_analysis/Projects/git_repos/Pedi_Immune/PD1_Treat/comparisonToUntreated/")

analysis_dir<- paste0(working_dir, "/analysis/score_programs/")
figure_dir<- paste0(working_dir, "/figures/score_programs/")
data_dir<- paste0(working_dir, "analysis/")

if(!dir.exists(figure_dir)){dir.create(figure_dir, recursive = TRUE)}
if(!dir.exists(analysis_dir)){dir.create(analysis_dir, recursive = TRUE)}

preprocessing = paste0(base_dir, script_dir, "single_cell_preprocessing_helper_functions.R")
nmf_helper = paste0(base_dir, script_dir, "NMF_helper_function.R")
source(preprocessing)
source(nmf_helper)
source("../HelperFunctions.R")

```



## Load seurat objects: pd-1 (processed in 01b_Preprocess_QC_ToSeurat.Rmd) and full immune cohort (both myeloid and t cells)
```{r}
## Set whether to use integrated or unintegrated objects
integration<- "Harmony" ## NoInt or Harmony
figure_dir_use<- paste0(figure_dir, integration, "/")
if(!dir.exists(figure_dir_use)){dir.create(figure_dir_use)}

full_cohort_dir<- "../../ImmuneCellAnalysis/"


## Load merged ss2
ss2_files<- list.files(data_dir, pattern="seurat")
ss2_files<- ss2_files[grepl("ss", ss2_files)]
if(integration=="NoInt"){ss2_files<- ss2_files[grepl("noHarmony", ss2_files)]
} else if(integration=="Harmony"){ss2_files<- ss2_files[grepl("_Harmony", ss2_files)]}


ss2_seurat<- lapply(ss2_files, function(x){readRDS(paste0(data_dir, x))})
names(ss2_seurat)<-  gsub("_noHarmony_seurat.Rds", "",gsub("_Harmony_seurat.Rds", "", ss2_files))
ss2_seurat<- lapply(ss2_seurat, function(x){x$Sequencing<- "SS2"; return(x)})

## Load merged 10x
tenx_files<-list.files(data_dir, pattern="seurat")
tenx_files<- list.files(data_dir, pattern="tenx")
if(integration=="NoInt"){tenx_files<- tenx_files[grepl("noHarmony", tenx_files)]
} else if(integration=="Harmony"){tenx_files<- tenx_files[grepl("_Harmony", tenx_files)]}

tenx_seurat<- lapply(tenx_files, function(x){readRDS(paste0(data_dir, x))})
names(tenx_seurat)<-  gsub("_noHarmony_seurat.Rds", "", gsub("_Harmony_seurat.Rds", "", tenx_files))
tenx_seurat<- lapply(tenx_seurat, function(x){x$Sequencing<- "TenX"; return(x)})


## Colors 
tcell_colors<- readRDS(paste0(full_cohort_dir, "/plot_colors/Tcell.programs_rank8sharedByunion_reAnnot.Rds"))
myeloid_colors<- readRDS(paste0(full_cohort_dir, "/plot_colors/Myeloid_program_colors.Rds"))
myeloid_colors<- myeloid_colors$rank6
immune_colors<- c(tcell_colors, myeloid_colors)

## Full cohort marker genes
tcell_markers<- readRDS(paste0(full_cohort_dir, 
                             "02a_Tcells/02_Ped.Adult/01_compare_NMF/analysis/newMarkers_deNovoPed.AdultTcell/", 
                             "new_markers_NMFrank8_bySeurat_sharedByunion_reAnnot.Rds"))
myeloid_markers<- read.csv(paste0(full_cohort_dir,
                               "02b_Myeloid/01a_NMF/analysis/de.novoNMF/pedOnly_nomuv63/", 
                               "top_DE_genes_10Xannotated_NMF_rank6.csv"))

  ## Top 3 markers per program
  top_tcell_markers<- tcell_markers %>% group_by(cluster) %>% top_n(n=3, wt=avg_log2FC) %>% as.data.frame()
  top_myeloid_markers<- myeloid_markers %>% group_by(cluster) %>% top_n(n=3, wt=avg_log2FC) %>% as.data.frame()
  
  ## Split to list
  tcell_list<- split(tcell_markers, f=tcell_markers$cluster)
  tcell_list<- lapply(tcell_list, function(x){x$gene})
  
  myeloid_list<- split(myeloid_markers, f=myeloid_markers$cluster)
  myeloid_list<- lapply(myeloid_list, function(x){x$gene})
  
  ## Create cd4/cd8 program lists (e.g., no tregs for cd8)
  cd8_list<- tcell_list[!names(tcell_list) %in% c("Inhibitory", "Treg")]
  cd4_list<- tcell_list[!names(tcell_list) %in% c("Cytotoxic.NKreceptor", "Predysfunctional")]

```

## Score for markers, assign to max
```{r}
## SS2
ss2_seurat$ss_cd4<-my_scoreAddMax(ss2_seurat$ss_cd4, cd4_list)
ss2_seurat$ss_cd8<-my_scoreAddMax(ss2_seurat$ss_cd8, cd8_list)
ss2_seurat$ss_myeloid<-my_scoreAddMax(ss2_seurat$ss_myeloid, myeloid_list)


## 10x
tenx_seurat$tenx_cd4<-my_scoreAddMax(tenx_seurat$tenx_cd4, cd4_list)
tenx_seurat$tenx_cd8<-my_scoreAddMax(tenx_seurat$tenx_cd4, cd8_list)
tenx_seurat$tenx_myeloid<-my_scoreAddMax(tenx_seurat$tenx_myeloid, myeloid_list)

saveRDS(ss2_seurat, file=paste0(analysis_dir, "../ss2_seurat_list_cd4.cd8.myeloid.Rds"))
saveRDS(tenx_seurat, file=paste0(analysis_dir, "../tenx_seurat_list_cd4.cd8.myeloid.Rds"))
```

## For samples from full cohort, plot change in annotations (i.e., accuracy)
```{r}
all_plots<- lapply(names(ss2_seurat), function(x){
  tmp<- ss2_seurat[[x]]@meta.data
  bd<- as.data.frame(table(tmp$Final_Annot, tmp$max_Program_scored))
  colnames(bd)<-c("OriginalAnnotation", "ProjectedAnnotation", "NumberOfCells")
  my_sankeyPlot(bd, immune_colors) + ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=1)
ggsave(paste0(figure_dir, "SS2_Sankey_ChangeInAnnotation_Original.v.Projected.png"), width=6, height=12)
```


## Worse accuracy with scoring compared to projection
Downstream, projection used to assign programs, NOT scoring
As of 10/31/22, nothing below here run. Keeping in case want to revisit this





## UMAPs of projected programs
```{r}
## SS2
all_plots<- lapply(names(ss2_seurat), function(x){
  tmp<- ss2_seurat[[x]]
  DimPlot(tmp, group.by="max_Program_scored", pt.size = 1, label=FALSE, label.size = 6)+ 
    scale_color_manual(values=immune_colors[names(immune_colors) %in% tmp$max_Program_scored])+
    ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "SS2_UMAP_PredictedProgram.png"), width=18, height=5)

## 10X
all_plots<- lapply(names(tenx_seurat), function(x){
  tmp<- tenx_seurat[[x]]
  DimPlot(tmp, group.by="max_Program_scored", pt.size = 1, label=FALSE, label.size = 6)+ 
    scale_color_manual(values=immune_colors[names(immune_colors) %in% tmp$max_Program_scored])+
    ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "TenX_UMAP_PredictedProgram.png"), width=18, height=5)
```

## Barchart of program proportions
```{r}
## SS2
all_plots<- lapply(names(ss2_seurat), function(x){
  tmp<- ss2_seurat[[x]]
  my_barchart_programProp(tmp, coloring_variable = "max_Program_scored", colors=immune_colors)+ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "SS2_Barchart_PredictedProgram.png"), width=18, height=5)

## 10x
all_plots<- lapply(names(tenx_seurat), function(x){
  tmp<- tenx_seurat[[x]]
  my_barchart_programProp(tmp, coloring_variable = "max_Program_scored", colors=immune_colors)+ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "TenX_Barchart_PredictedProgram.png"), width=18, height=5)

## Merge 10x/ss2, plot proportions
samples<- c("BT1478", "BT1857","BT1745", "E167", "BT1910", "BT1935", "GEX")
all_plots<- lapply(gsub("tenx_", "", names(tenx_seurat)), function(x){
  tmp<- merge(tenx_seurat[[paste0("tenx_", x)]], ss2_seurat[[paste0("ss_", x)]])
  tmp$sample<- factor(tmp$sample, levels=samples[samples %in% tmp$sample])
  my_barchart_programProp(tmp, coloring_variable = "max_Program_scored", colors=immune_colors)+ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "SS2.TenX_Barchart_PredictedProgram.png"), width=25, height=5)
```


## Plot GOI
```{r}
goi<- c("PTGER2", "SELPLG", "PDCD1", "CTLA4", "GNLY","GZMA", "FOXP3", "CD3G")

all_plots<- lapply(names(tenx_seurat), function(x){
  tmp<- tenx_seurat[[x]]
  DotPlot(tmp, group.by = "Treatment", features=goi)+
    scale_color_gradient2(low="blue", mid="white", high="red")+ggtitle(x)+
    theme(axis.text.x = element_text(angle=45, hjust=1))
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "TenX_DotPlot_GOI_byTreatment.png"), width=16, height=4)

all_plots<- lapply(names(ss2_seurat), function(x){
  tmp<- ss2_seurat[[x]]
  DotPlot(tmp, group.by = "Treatment", features=goi)+
    scale_color_gradient2(low="blue", mid="white", high="red")+ggtitle(x)+
    theme(axis.text.x = element_text(angle=45, hjust=1))
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "SS2_DotPlot_GOI_byTreatment.png"), width=16, height=4)
```


## Pseudobulked heatmap of expression of marker genes
```{r}
marker_list<- list(cd4=top_tcell_markers[!top_tcell_markers$cluster %in% c("Predysfunctional", "Cytotoxic.NKreceptor"),], 
                   cd8=top_tcell_markers[!top_tcell_markers$cluster %in% c("Treg", "Inhibitory"),], 
                   myeloid=top_myeloid_markers)

## Merge (no clustering needed) across sequencing types
all_plots<- lapply(gsub("tenx_", "", names(tenx_seurat)), function(x){
  tmp<- merge(tenx_seurat[[paste0("tenx_", x)]], ss2_seurat[[paste0("ss_", x)]])
  markers_use<-marker_list[[x]]
  markers_use<- markers_use[markers_use$cluster %in% unique(tmp$max_Program_scored),]
  
  ## Create pseudobulking variable
  tmp$pb<- paste0(tmp$sample, "_", gsub("\\.", "\n", gsub("_", "\n", tmp$max_Program_scored)))
  pb<- pseudobulk_byVariable(tmp, tmp@meta.data, "pb")
  
  
  ## center for each sample separately
  center_bySample<- lapply(unique(tmp$sample), function(sample){
    pb_tmp<- pb[,grepl(sample, colnames(pb))]
    if(class(pb_tmp)=="numeric"){
      pb_tmp<- as.data.frame(pb_tmp)
      colnames(pb_tmp)<- colnames(pb)[grepl(sample, colnames(pb))]
    }
    pb_list_tmp<- NormCenter(pb_tmp)
    pb_center_tmp<- pb_list_tmp$center_data
    return(pb_center_tmp)
  })
  center_bySample<- do.call("cbind", center_bySample)

  
  ## Plot
  myHeatmap(center_bySample, GOI=markers_use$gene, min.value = -3, max.value = 3, 
                orderFactors =  gsub("\\.", "\n",gsub("_", "\n", unique(markers_use$cluster))),
            orderSubtypes =c("BT1478", "BT1857","BT1745", "E167", "BT1910", "BT1935", "GEX") ) +
    scale_fill_gradient2(high="red", low="blue", mid="white", name="Centered log2(TPM)")+
    ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "Heatmap_ExpectedMarkerGenes_All.png"), width=35, height=9)
```
