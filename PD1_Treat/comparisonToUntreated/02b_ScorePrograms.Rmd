---
title: "ProjectBroadAnnots.Rmd"
author: "Jenna LaBelle"
date: "10/07/22"
output: html_document
---

## Score programs from the full immune cohort for the treated/10x samples

```{r}
library(Seurat) 

base_dir = "/Users/jlabelle/"
base_dir = "C:/Users/jenna/"
script_dir = "Dropbox (Partners HealthCare)/FilbinLab/data_analysis/Scripts/"
working_dir<- paste0(base_dir, 
                     "Dropbox (Partners HealthCare)/FilbinLab/",
                     "data_analysis/Projects/git_repos/Pedi_Immune/PD1_Treat/comparisonToUntreated/")

analysis_dir<- paste0(working_dir, "/analysis/score_programs/")
figure_dir<- paste0(working_dir, "/figures/score_programs/")
data_dir<- paste0(working_dir, "analysis/")

if(!dir.exists(figure_dir)){dir.create(figure_dir, recursive = TRUE)}
if(!dir.exists(analysis_dir)){dir.create(analysis_dir, recursive = TRUE)}

preprocessing = paste0(base_dir, script_dir, "single_cell_preprocessing_helper_functions.R")
nmf_helper = paste0(base_dir, script_dir, "NMF_helper_function.R")
source(preprocessing)
source(nmf_helper)
source("../HelperFunctions.R")

```



## Load seurat objects: pd-1 (processed in 01b_Preprocess_QC_ToSeurat.Rmd) and full immune cohort (both myeloid and t cells)
```{r}
## Set whether to use integrated or unintegrated objects
integration<- "Harmony" ## NoInt or Harmony
figure_dir_use<- paste0(figure_dir, integration, "/")
if(!dir.exists(figure_dir_use)){dir.create(figure_dir_use)}

full_cohort_dir<- "../../ImmuneCellAnalysis/"


## Load merged ss2
ss2_files<- list.files(data_dir, pattern="ss")
if(integration=="NoInt"){ss2_files<- ss2_files[grepl("noHarmony", ss2_files)]
} else if(integration=="Harmony"){ss2_files<- ss2_files[!grepl("noHarmony", ss2_files)]}


ss2_seurat<- lapply(ss2_files, function(x){readRDS(paste0(data_dir, x))})
names(ss2_seurat)<-  gsub("_noHarmony_seurat.Rds", "",gsub("_seurat.Rds", "", ss2_files))
ss2_seurat<- lapply(ss2_seurat, function(x){x$Sequencing<- "SS2"; return(x)})

## Load merged 10x
tenx_files<- list.files(data_dir, pattern="tenx")
if(integration=="NoInt"){tenx_files<- tenx_files[grepl("noHarmony", tenx_files)]
} else if(integration=="Harmony"){tenx_files<- tenx_files[!grepl("noHarmony", tenx_files)]}

tenx_seurat<- lapply(tenx_files, function(x){readRDS(paste0(data_dir, x))})
names(tenx_seurat)<-  gsub("_noHarmony_seurat.Rds", "", gsub("_seurat.Rds", "", tenx_files))
tenx_seurat<- lapply(tenx_seurat, function(x){x$Sequencing<- "TenX"; return(x)})


## Colors 
tcell_colors<- readRDS(paste0(full_cohort_dir, "/plot_colors/Tcell.programs_rank8sharedByunion_reAnnot.Rds"))
myeloid_colors<- readRDS(paste0(full_cohort_dir, "/plot_colors/Myeloid_program_colors.Rds"))
myeloid_colors<- myeloid_colors$rank6
immune_colors<- c(tcell_colors, myeloid_colors)

## Full cohort marker genes
tcell_markers<- readRDS(paste0(full_cohort_dir, 
                             "02a_Tcells/02_Ped.Adult/01_compare_NMF/analysis/newMarkers_deNovoPed.AdultTcell/", 
                             "new_markers_NMFrank8_bySeurat_sharedByunion_reAnnot.Rds"))
myeloid_markers<- read.csv(paste0(full_cohort_dir,
                               "02b_Myeloid/01a_NMF/analysis/de.novoNMF/pedOnly_nomuv63/", 
                               "top_DE_genes_10Xannotated_NMF_rank6.csv"))

  ## Top 3 markers per program
  top_tcell_markers<- tcell_markers %>% group_by(cluster) %>% top_n(n=3, wt=avg_log2FC) %>% as.data.frame()
  top_myeloid_markers<- myeloid_markers %>% group_by(cluster) %>% top_n(n=3, wt=avg_log2FC) %>% as.data.frame()
  
  ## Split to list
  tcell_list<- split(tcell_markers, f=tcell_markers$cluster)
  tcell_list<- lapply(tcell_list, function(x){x$gene})
  
  myeloid_list<- split(myeloid_markers, f=myeloid_markers$cluster)
  myeloid_list<- lapply(myeloid_list, function(x){x$gene})
  
  ## Create cd4/cd8 program lists (e.g., no tregs for cd8)
  cd8_list<- tcell_list[!names(tcell_list) %in% c("Inhibitory", "Treg")]
  cd4_list<- tcell_list[!names(tcell_list) %in% c("Cytotoxic.NKreceptor", "Predysfunctional")]

```

## Score for markers, assign to max
```{r}
## SS2
ss2_seurat$ss_cd4<-my_scoreAddMax(ss2_seurat$ss_cd4, cd4_list)
ss2_seurat$ss_cd8<-my_scoreAddMax(ss2_seurat$ss_cd8, cd8_list)
ss2_seurat$ss_myeloid<-my_scoreAddMax(ss2_seurat$ss_myeloid, myeloid_list)


## 10x
tenx_seurat$tenx_cd4<-my_scoreAddMax(tenx_seurat$tenx_cd4, cd4_list)
tenx_seurat$tenx_cd8<-my_scoreAddMax(tenx_seurat$tenx_cd4, cd8_list)
tenx_seurat$tenx_myeloid<-my_scoreAddMax(tenx_seurat$tenx_myeloid, myeloid_list)
```

## For samples from full cohort, plot change in annotations (i.e., accuracy)
```{r}
all_plots<- lapply(names(ss2_seurat), function(x){
  tmp<- ss2_seurat[[x]]@meta.data
  bd<- as.data.frame(table(tmp$Final_Annot, tmp$max_Program_scored))
  colnames(bd)<-c("OriginalAnnotation", "ProjectedAnnotation", "NumberOfCells")
  my_sankeyPlot(bd, immune_colors) + ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=1)
ggsave(paste0(figure_dir, "SS2_Sankey_ChangeInAnnotation_Original.v.Projected.png"), width=6, height=12)
```


## Worse accuracy with scoring compared to projection
Downstream, projection used to assign programs, NOT scoring
As of 10/31/22, nothing below here run. Keeping in case want to revisit this





## UMAPs of projected programs
```{r}
## SS2
all_plots<- lapply(names(ss2_seurat), function(x){
  tmp<- ss2_seurat[[x]]
  DimPlot(tmp, group.by="Program_projected", pt.size = 1, label=FALSE, label.size = 6)+ 
    scale_color_manual(values=immune_colors[names(immune_colors) %in% tmp$Program_projected])+
    ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "SS2_UMAP_PredictedProgram.png"), width=18, height=5)

## 10X
all_plots<- lapply(names(tenx_seurat), function(x){
  tmp<- tenx_seurat[[x]]
  DimPlot(tmp, group.by="Program_projected", pt.size = 1, label=FALSE, label.size = 6)+ 
    scale_color_manual(values=immune_colors[names(immune_colors) %in% tmp$Program_projected])+
    ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "TenX_UMAP_PredictedProgram.png"), width=18, height=5)
```

## Barchart of program proportions
```{r}
## SS2
all_plots<- lapply(names(ss2_seurat), function(x){
  tmp<- ss2_seurat[[x]]
  my_barchart_programProp(tmp, coloring_variable = "Program_projected", colors=immune_colors)+ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "SS2_Barchart_PredictedProgram.png"), width=18, height=5)

## 10x
all_plots<- lapply(names(tenx_seurat), function(x){
  tmp<- tenx_seurat[[x]]
  my_barchart_programProp(tmp, coloring_variable = "Program_projected", colors=immune_colors)+ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "TenX_Barchart_PredictedProgram.png"), width=18, height=5)

## Merge 10x/ss2, plot proportions
all_plots<- lapply(gsub("tenx_", "", names(tenx_seurat)), function(x){
  tmp<- merge(tenx_seurat[[paste0("tenx_", x)]], ss2_seurat[[paste0("ss_", x)]])
  tmp$sample<- factor(tmp$sample, levels=c("BT1478", "BT1857","BT1745", "E167CD35resub", "BT1910", "BT1935", "GEX"))
  my_barchart_programProp(tmp, coloring_variable = "Program_projected", colors=immune_colors)+ggtitle(x)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "SS2.TenX_Barchart_PredictedProgram.png"), width=25, height=5)
```


## Plot GOI
```{r}
goi<- c("PTGER2", "SELPLG", "PDCD1", "CTLA4", "GNLY","GZMA", "FOXP3", "CD3G")

all_plots<- lapply(names(tenx_seurat), function(x){
  tmp<- tenx_seurat[[x]]
  DotPlot(tmp, group.by = "Treatment", features=goi)+
    scale_color_gradient2(low="blue", mid="white", high="red")+ggtitle(x)+
    theme(axis.text.x = element_text(angle=45, hjust=1))
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "TenX_DotPlot_GOI_byTreatment.png"), width=16, height=4)

all_plots<- lapply(names(ss2_seurat), function(x){
  tmp<- ss2_seurat[[x]]
  DotPlot(tmp, group.by = "Treatment", features=goi)+
    scale_color_gradient2(low="blue", mid="white", high="red")+ggtitle(x)+
    theme(axis.text.x = element_text(angle=45, hjust=1))
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir_use, "SS2_DotPlot_GOI_byTreatment.png"), width=16, height=4)
```


Nothing after here run yet
## Projection of cd4 programs to gbm cd4
```{r}
## Project full to pd1
pd1_cd4<- my_project_seurat(full_cd4_seurat, pd1_cd4, reference_annotation = "NMF_rank8_annot_mergedByunion_reAnnot")


## plot
DimPlot(pd1_cd4, group.by="Program_projected", pt.size = 1, label=FALSE, label.size = 6)+ 
  scale_color_manual(values=tcell_colors[names(tcell_colors) %in% pd1_cd4$Program_projected])
ggsave(paste0(figure_dir, "UMAP_CD4_program_projectedFromFull.png"), width=6, height=6)

## Proportion of programs by sample
my_barchart_programProp(pd1_cd4, coloring_variable = "Program_projected", colors=tcell_colors)
ggsave(paste0(figure_dir, "Breakdown_CD4_programBySample.png"), width=4, height=4)

## Expression of expected (same as full cohort) genes in predicted programs
my_dotplot(pd1_cd4, "Program_projected", unique(my_orderFeatures_forDotplot(top_tcell_markers)$gene))
ggsave(paste0(figure_dir, "DotPlot_cd4_topMarkersForFullCohort.png"), width=6, height=8)

## Identify markers for project programs- match expectations?
cd4_markers<- my_get_markers(pd1_cd4, n_top=5, ident="Program_projected")

  ## Confirm expression of expected markers within predicted programs
  my_dotplot(pd1_cd4, "Program_projected", unique(my_orderFeatures_forDotplot(cd4_markers$top_markers)$gene))
  ggsave(paste0(figure_dir, "DotPlot_CD4_topMarkersForReidentifiedPredictedPrograms.png"), width=6, height=8)
  
## Histogram of max program scores for each program
## Helps to determine reasonable "Score too low" threshold
my_histMaxScores(pd1_cd4, "Program_projected", "max_Programscore_projected", tcell_colors)  
ggsave(paste0(figure_dir, "Histogram_CD4_maxProgramScore.png"), width=12, height=9)

## Grey out cells with low confidence score
low_score<- 0.4
pd1_cd4$Program_projected_lowScore<-ifelse(pd1_cd4$max_Programscore_projected<low_score, 
                                           "ScoreTooLow",
                                           pd1_cd4$Program_projected)
DimPlot(pd1_cd4, group.by = "Program_projected_lowScore")+
  scale_color_manual(values=c(tcell_colors[names(tcell_colors) %in% pd1_cd4$Program_projected],
                              ScoreTooLow="grey"))
ggsave(paste0(figure_dir, "UMAP_CD4_maxProgram_scoreTooLow", low_score, ".png"), width=6.5, height=5)

  ## Expression of expected (same as full cohort) genes in predicted programs
  my_dotplot(subset(pd1_cd4, Program_projected_lowScore != "ScoreTooLow"), 
             "Program_projected_lowScore", unique(my_orderFeatures_forDotplot(top_tcell_markers)$gene))
  ggsave(paste0(figure_dir, "DotPlot_CD4_topMarkersForFullCohort_scoreTooLow", low_score, ".png"), width=6, height=8)

  ## Identify markers for project programs- match expectations?
  cd4_markers_lowScore<- my_get_markers(pd1_cd4, n_top=5, ident="Program_projected_lowScore", excludeProgram = "ScoreTooLow")
  
  ## Confirm expression of expected markers within predicted programs
  my_dotplot(pd1_cd4, "Program_projected_lowScore", unique(my_orderFeatures_forDotplot(cd4_markers_lowScore$top_markers)$gene))
  ggsave(paste0(figure_dir, "DotPlot_CD4_topMarkersForReidentifiedPredictedPrograms_scoreTooLow", low_score, ".png"), width=6, height=8)

saveRDS(pd1_cd4, file=paste0(pd1_data_dir, "cd4_pd1_seurat.Rds"))
```

## Projection of cd8 programs to pd1 cd8
```{r}
pd1_cd8<- my_project_seurat(full_cd8_seurat, pd1_cd8, reference_annotation = "NMF_rank8_annot_mergedByunion_reAnnot")

## plot
DimPlot(pd1_cd8, group.by="Program_projected", pt.size = 1, label=FALSE, label.size = 6)+ 
  scale_color_manual(values=tcell_colors[names(tcell_colors) %in% pd1_cd8$Program_projected])
ggsave(paste0(figure_dir, "UMAP_CD8_program_projectedFromFull.png"), width=6, height=6)

## Proportion of programs by sample
my_barchart_programProp(pd1_cd8, coloring_variable = "Program_projected", colors=tcell_colors)
ggsave(paste0(figure_dir, "Breakdown_cd8_programBySample.png"), width=4, height=4)

## Expression of expected (same as full cohort) genes in predicted programs
my_dotplot(pd1_cd8, "Program_projected", unique(my_orderFeatures_forDotplot(top_tcell_markers)$gene))
ggsave(paste0(figure_dir, "DotPlot_cd8_topMarkersForFullCohort.png"), width=6, height=8)

## Identify markers for project programs- match expectations?
cd8_markers<- my_get_markers(pd1_cd8, n_top=5, ident="Program_projected")

  ## Expression of top markers for each predicted program
  my_dotplot(pd1_cd8, "Program_projected", unique(my_orderFeatures_forDotplot(cd8_markers$top_markers)$gene))
  ggsave(paste0(figure_dir, "DotPlot_cd8_topMarkersForReidentifiedPredictedPrograms.png"), width=6, height=8)

  
## Histogram of max program scores for each program
## Helps to determine reasonable "Score too low" threshold
my_histMaxScores(pd1_cd8, "Program_projected", "max_Programscore_projected", tcell_colors)  
ggsave(paste0(figure_dir, "Histogram_CD8_maxProgramScore.png"), width=12, height=9)

## Grey out cells with low confidence score
low_score<- 0.4
pd1_cd8$Program_projected_lowScore<-ifelse(pd1_cd8$max_Programscore_projected<low_score, 
                                           "ScoreTooLow",
                                           pd1_cd8$Program_projected)
DimPlot(pd1_cd8, group.by = "Program_projected_lowScore")+
  scale_color_manual(values=c(tcell_colors[names(tcell_colors) %in% pd1_cd8$Program_projected],
                              ScoreTooLow="grey"))
ggsave(paste0(figure_dir, "UMAP_CD8_maxProgram_scoreTooLow", low_score, ".png"), width=6.5, height=5)

  ## Expression of expected (same as full cohort) genes in predicted programs
  my_dotplot(subset(pd1_cd8, Program_projected_lowScore != "ScoreTooLow"), 
             "Program_projected_lowScore", unique(my_orderFeatures_forDotplot(top_tcell_markers)$gene))
  ggsave(paste0(figure_dir, "DotPlot_cd8_topMarkersForFullCohort_scoreTooLow", low_score, ".png"), width=6, height=8)

  ## Identify markers for project programs- match expectations?
  cd8_markers_lowScore<- my_get_markers(pd1_cd8, n_top=5, ident="Program_projected_lowScore", excludeProgram = "ScoreTooLow")
  
  ## Confirm expression of expected markers within predicted programs
  my_dotplot(pd1_cd8, "Program_projected_lowScore", unique(my_orderFeatures_forDotplot(cd8_markers_lowScore$top_markers)$gene))
  ggsave(paste0(figure_dir, "DotPlot_cd8_topMarkersForReidentifiedPredictedPrograms_scoreTooLow", low_score, ".png"), width=6, height=8)

saveRDS(pd1_cd8, file=paste0(pd1_data_dir, "cd8_pd1_seurat.Rds"))
```

## Projection of myeloid programs to pd1 myeloid
```{r}
pd1_myeloid<- my_project_seurat(full_myeloid_seurat, pd1_myeloid, reference_annotation = "NMF_rank6_annotByAdult10X")

## plot
DimPlot(pd1_myeloid, group.by="Program_projected", pt.size = 1, label=FALSE, label.size = 6)+ 
  scale_color_manual(values=myeloid_colors[names(myeloid_colors) %in% pd1_myeloid$Program_projected])
ggsave(paste0(figure_dir, "UMAP_myeloid_program_projectedFromFull.png"), width=6, height=6)

## Proportion of programs by sample
my_barchart_programProp(pd1_myeloid, coloring_variable = "Program_projected", colors=myeloid_colors)
ggsave(paste0(figure_dir, "Breakdown_myeloid_programBySample.png"), width=4, height=4)

## Expression of expected (same as full cohort) genes in predicted programs
my_dotplot(pd1_myeloid, "Program_projected", unique(my_orderFeatures_forDotplot(top_myeloid_markers)$gene))
ggsave(paste0(figure_dir, "DotPlot_myeloid_topMarkersForFullCohort.png"), width=6, height=8)

## Identify markers for project programs- match expectations?
myeloid_markers<- my_get_markers(pd1_myeloid, n_top=5, ident="Program_projected")

  ## Expression of top markers for each predicted program
  my_dotplot(pd1_myeloid, "Program_projected", unique(my_orderFeatures_forDotplot(myeloid_markers$top_markers)$gene))
  ggsave(paste0(figure_dir, "DotPlot_myeloid_topMarkersForReidentifiedPredictedPrograms.png"), width=6, height=8)

  
## Histogram of max program scores for each program
## Helps to determine reasonable "Score too low" threshold
my_histMaxScores(pd1_myeloid, "Program_projected", "max_Programscore_projected", myeloid_colors)  
ggsave(paste0(figure_dir, "Histogram_myeloid_maxProgramScore.png"), width=12, height=9)

## Grey out cells with low confidence score
low_score<- 0.4
pd1_myeloid$Program_projected_lowScore<-ifelse(pd1_myeloid$max_Programscore_projected<low_score, 
                                           "ScoreTooLow",
                                           pd1_myeloid$Program_projected)
DimPlot(pd1_myeloid, group.by = "Program_projected_lowScore")+
  scale_color_manual(values=c(myeloid_colors[names(myeloid_colors) %in% pd1_myeloid$Program_projected],
                              ScoreTooLow="grey"))
ggsave(paste0(figure_dir, "UMAP_myeloid_maxProgram_scoreTooLow", low_score, ".png"), width=6.5, height=5)

  ## Expression of expected (same as full cohort) genes in predicted programs
  my_dotplot(subset(pd1_myeloid, Program_projected_lowScore != "ScoreTooLow"), 
             "Program_projected_lowScore", unique(my_orderFeatures_forDotplot(top_myeloid_markers)$gene))
  ggsave(paste0(figure_dir, "DotPlot_myeloid_topMarkersForFullCohort_scoreTooLow", low_score, ".png"), width=6, height=8)

  ## Identify markers for project programs- match expectations?
  myeloid_markers_lowScore<- my_get_markers(pd1_myeloid, n_top=5, ident="Program_projected_lowScore", excludeProgram = "ScoreTooLow")
  
  ## Confirm expression of expected markers within predicted programs
  my_dotplot(pd1_myeloid, "Program_projected_lowScore", unique(my_orderFeatures_forDotplot(myeloid_markers_lowScore$top_markers)$gene))
  ggsave(paste0(figure_dir, "DotPlot_myeloid_topMarkersForReidentifiedPredictedPrograms_scoreTooLow", low_score, ".png"), width=6, height=8)

saveRDS(pd1_myeloid, file=paste0(pd1_data_dir, "myeloid_pd1_noDC.B_seurat.Rds"))
```


