---
title: "DetailedAnnotation"
author: "Jenna LaBelle"
date: "11/04/21"
output: html_document
---

Detailed annotation for tcells and myeloid cells for BT2061. 
Tcells: CD4, CD8- project from full cohort
Myeloid: any DC, B cells- manaully check based on marker genes

```{r}
library(Seurat) 

base_dir = "/Users/jlabelle/"
script_dir = "Dropbox (Partners HealthCare)/FilbinLab/data_analysis/Shared/Scripts/"
working_dir<- paste0(base_dir, 
                     "Dropbox (Partners HealthCare)/FilbinLab/",
                     "data_analysis/Projects/git_repos/Pedi_Immune/ImmuneCellAnalysis/01_Preprocessing/BT2061_Preprocessing/02_Counts_Preprocess/")

analysis_dir<- paste0(working_dir, "/analysis/detailed_annotation/")
figure_dir<- paste0(working_dir, "/figures/detailed_annotation/")
data_dir<- paste0("analysis/broad_annotation/")

if(!dir.exists(figure_dir)){dir.create(figure_dir)};if(!dir.exists(analysis_dir)){dir.create(analysis_dir)}

preprocessing = paste0(base_dir, script_dir, "single_cell_preprocessing_helper_functions.R")
nmf_helper = paste0(base_dir, script_dir, "NMF_helper_function.R")
source(preprocessing)
source(nmf_helper)
source(paste0(base_dir, script_dir, "seurat_transferAnchors_helper.R"))

```

## Read in processed seurat objects
```{r}
## BT2061
immune_seurat<- readRDS(paste0(data_dir,"tcell.myeloid_seurat.Rds"))
tcell_seurat<- readRDS(paste0(data_dir,   "tcell_seurat.Rds"))
myeloid_seurat<- readRDS(paste0(data_dir, "myeloid_seurat.Rds"))

## Full cohort
tcell_data_dir<- "../../../02a_Tcells/02_Ped.Adult/03_Visualize.Reannotate_programs/analysis/Reannotate_programs/"
tcell_data_dir<- paste0(tcell_data_dir, "rank8_sharedByunion/")
full_tcell_seurat<- readRDS(paste0(tcell_data_dir, "ped_seurat_tcell_harmony.Rds"))

## colors
immune_colors<- readRDS("../../../plot_colors/ImmuneCell.celltypes.Rds")
```


#############################
## Myeloid cell annotation ##
#############################

For now, just identifying B cells and dendritic cells
May also identify/annotation macrophages and microglia here
```{r}
## for harmony integration, pedOnly_nomuv63: need to increase resolution in order to split DC cluster
myeloid_seurat<- FindClusters(myeloid_seurat, resolution = 1)

bcell_markers<- c("CD19", "MS4A1")
dendritic_markers<- c("FLT3", "CD207", "CD1A", "CD1C", "FCER1A",
                      "NOTCH2")

FeaturePlot(myeloid_seurat, features=bcell_markers, ncol = 2)
ggsave(paste0(figure_dir, "Myeloid_BcellMarkers.png"), width=8, height=4)

## No B cells or DC to remove


```

############################
## Identify CD4/CD8 cells ##
############################

Project detailed annotations from full cohort- too few t cells to annotate manually
This approach doesn't work well- CD4 expresses both, CD8 onyl expresses CD8
```{r}
tcell_seurat<- my_project_seurat(subset(full_tcell_seurat, Final_detailed_annot!="Unclear"), 
                                 tcell_seurat, 
                                 reference_annotation = "Final_detailed_annot", 
                                 k.weight = ncol(tcell_seurat)-1,
                                 prediction_colNames = c("detailed_annot_projected",
                                                         "CD4_score_projected","CD8_score_projected", "Max_score_projected"))

## Check expression of expected marker genes
p1<-DimPlot(tcell_seurat, group.by = "detailed_annot_projected")+
  scale_color_manual(values=immune_colors[names(immune_colors) %in% tcell_seurat$Program_projected])
p2<-VlnPlot(tcell_seurat, group.by = "Program_projected", features=c("CD4", "CD8A"), cols=immune_colors)
p3<- FeaturePlot(tcell_seurat, features=c("CD4", "CD8A"), cols=c("grey", "red"))
p1+p2+p3
ggsave(paste0(figure_dir, "Tcells_detailedAnnot.png"), width=15, height=4)


saveRDS(tcell_seurat, file=paste0(data_dir, "tcell_seurat.Rds" ))
```

Alternative: merge with full cohort, then project annotations again, but only use the new annotations for BT2061
Revealed high mitochondrial gene expression in new batch + distantly clusters. Low quality, cannot use this data..
```{r}
## Merge all and rerun clustering
merged_tcell<- merge(full_tcell_seurat, tcell_seurat)
merged_meta<- merged_tcell@meta.data
merged_tcell<- RunFullSeurat(merged_tcell@assays$RNA@counts, RunHarmony = TRUE, samples=merged_tcell$sample)
merged_tcell<- AddMetaData(merged_tcell, merged_meta[,!colnames(merged_meta) %in% colnames(merged_tcell@meta.data)])

## Plot by batch
merged_tcell$batch<- ifelse(merged_tcell$sample== "BT2061", "new", "old")
DimPlot(merged_tcell, group.by = "batch")+scale_color_manual(values=c(new="red", old="grey"))
ggsave(paste0(figure_dir, "UMAP_Tcells_mergedOriginal.BT2061.png"), width=5, height=4)

## Clusters by batch- why? markers?
merged_tcell<- SetIdent(merged_tcell, value=merged_tcell$batch)
markers<- FindAllMarkers(merged_tcell)
markers_filt<- markers[markers$p_val_adj<0.05,]
top_markers<- markers_filt %>% group_by(cluster) %>% top_n(n=10, wt=avg_log2FC) %>% as.data.frame()
 
## Top markers for BT2061 are all mitochondrial- add percent mito and plot
marker_dir<- paste0(base_dir,script_dir, "../", "Marker_genes/")
hkgenes <- read.table(paste0(marker_dir, "tirosh_house_keeping.txt"), skip = 2)
hkgenes <- as.vector(hkgenes$V1)
hkgenes.notfound.indices <- which(!hkgenes %in% rownames(merged_tcell))  
hkgenes.found <- hkgenes[-hkgenes.notfound.indices]
merged_tcell$per_mito<- PercentageFeatureSet(merged_tcell, pattern = "^MT-")
FeaturePlot(merged_tcell, features="per_mito")
ggsave(paste0(figure_dir, "UMAP_Tcells_mergedOriginal.BT2061_perMito.png"), width=5, height=4)
```

