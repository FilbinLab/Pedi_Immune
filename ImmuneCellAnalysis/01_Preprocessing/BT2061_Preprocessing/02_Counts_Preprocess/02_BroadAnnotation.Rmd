---
title: "BroadAnnotation"
author: "Jenna LaBelle"
date: "11/04/21"
output: html_document
---

## Purpose:
Broad level annotation (Tcell vs Myeloid, CD4 vs CD8) 


## Approach:
Expression of common marker genes, perform cluster-wise annotation. Have option to use harmony-integrated or non-integrated seurat objects (no integration used for final analysis for assigning tcell/myeloid)

```{r}
library(Seurat) 

base_dir = "/Users/jlabelle/"
script_dir = "Dropbox (Partners HealthCare)/FilbinLab/data_analysis/Scripts/"
working_dir<- paste0(base_dir, 
                     "Dropbox (Partners HealthCare)/FilbinLab/",
                     "data_analysis/Projects/git_repos/Pedi_Immune/ImmuneCellAnalysis/01_Preprocessing/BT2061_Preprocessing/02_Counts_Preprocess/")

analysis_dir<- paste0(working_dir, "/analysis/broad_annotation/")
figure_dir<- paste0(working_dir, "/figures/broad_annotation/")

if(!dir.exists(figure_dir)){dir.create(figure_dir)};if(!dir.exists(analysis_dir)){dir.create(analysis_dir)}

preprocessing = paste0(base_dir, script_dir, "single_cell_preprocessing_helper_functions.R")
nmf_helper = paste0(base_dir, script_dir, "NMF_helper_function.R")
source(preprocessing)
source(nmf_helper)

```


## Load in processed seurat object 
```{r}
immune_seurat<- readRDS("analysis/immune_seurat.Rds")
```


##################################
## Identify Tcell/Myeloid cells ##
##################################

## Basic plot to determine myeloid/tcell
## Note: these figures were also generated for seurat object BEFORE removing cluster 11 (low quality)
## These pre-removal figures are in figures/broadAnnotation/WithCluster11/
## Figures in figures/merge_samples/broadAnnotation do NOT include cluster 11
```{r}
FeaturePlot(immune_seurat, features=c("CD4", "CD8A", "CD3G","CD2", "CD247", "CD14", "CSF1R"), ncol= 4)
ggsave(paste0(figure_dir, "UMAP_Tcell.Myeloid_Markers.png"), width=16, height=8)

VlnPlot(immune_seurat, features=c("CD4", "CD8A", "CD3G", "CSF1R","CD2", "CD247", "CD14"))
ggsave(paste0(figure_dir, "Vln_Tcell.Myeloid_Markers.png"), width=8, height=20)

DimPlot(immune_seurat, label=TRUE)+NoLegend()
ggsave(paste0(figure_dir, "UMAP_seurat.png"), width=6, height=6)

# Glial cells
genes.astrocytes <- c("APOE", "SLC1A2", "SLC1A3", "ALDOC", "GFAP", "CLU", "GPM6B", "TUBA1A", "NGFRAP1", "CD9", "GFAP", "CKB", "PTGDS", "S100B", "STMN1")
immune_seurat <- AddModuleScore(immune_seurat, list(genes.astrocytes), ctrl = 10, name = c("astrocyte"))
FeaturePlot(immune_seurat, c("astrocyte1"))
ggsave(paste0(figure_dir, "UMAP_astrocyte.png"), width = 6, height = 6)

# Cyototxicity 
genes.cytotoxicity <- c("PRF1", "GZMB", "GZMA", "GZMH", "NKG7", "GNLY")
immune_seurat <- AddModuleScore(immune_seurat, list(genes.cytotoxicity), ctrl = 10, name = c("cytotoxicity"))
FeaturePlot(immune_seurat, c("cytotoxicity1"))
ggsave(paste0(figure_dir, "_UMAP_cytotoxicity.png"), width = 8, height = 8)

# Antigen presenting cells
genes.APC <- c("CD74", "CD86", "LYZ", "MS4A7", "FCER1G", "FCGR3A", "CD14", "CBFA2T3", "CD163", "CD33", "ID2")
FeaturePlot(immune_seurat, genes.APC,pt.size = 1)
ggsave(paste0(figure_dir, "UMAP_APC.png"), width = 12, height = 9)

# T cells
genes.Tcell <- c("CD3D", "CD3E", "CD4","CD8A", "CD28")
FeaturePlot(immune_seurat, genes.Tcell,  pt.size = 1)
ggsave(paste0(figure_dir, "UMAP_Tcell.png"), width =12, height = 9)

# Th17
genes.Th17 <- c("IL17A", "IL17F", "IL23R", "IL22", "RORC", "PLZF")
FeaturePlot(immune_seurat, genes.Th17,  pt.size = 1)
ggsave(paste0(figure_dir, "UMAP_Tcell_Th17.png"), width = 6, height = 9)

# Treg cells
genes.Treg <- c("CD4","CD25","FOXP3","SMAD3","STAT5A", "STAT5B")
FeaturePlot(immune_seurat, genes.Treg,  pt.size = 1)
ggsave(paste0(figure_dir, "UMAP_Tcell_Treg.png"), width = 6, height = 9)

# Th1 cells
genes.Th1 <- c("CD4","CXCR3","TBX21","STAT1","STAT6")
FeaturePlot(immune_seurat, genes.Th1,  pt.size = 1)
ggsave(paste0(figure_dir, "UMAP_Tcell_Th1.png"), width = 6, height = 9)

# Inhibitory T cell markers (HAVCR2 = TIM-3)
genes.inhibit <- c("PDCD1", "CTLA4", "HAVCR2", "LAG3", "TIGIT")
FeaturePlot(immune_seurat, genes.inhibit,  pt.size = 1)
ggsave(paste0(figure_dir, "UMAP_Tcell_inhibit.png"), width = 6, height = 9)

# T cell Cytokines
genes <- c("IL2", "IFNG", "TNF", "IL10", "TGFB1", "TGFB2")
FeaturePlot(immune_seurat, genes,  pt.size = 1)
ggsave(paste0(figure_dir, "UMAP_Tcell_cytokine.png"), width = 6, height = 9)

# T-cell cytotoxicity
genes <- c("GZMA", "GZMB", "PRF1")
FeaturePlot(immune_seurat, genes,  pt.size = 1)
ggsave(paste0(figure_dir, "UMAP_Tcell_cytotoxic.png"), width = 8, height = 8)

# T cell activation/regulatory
genes <- c("HLA-DRA", "ICOS", "TNFRSF4", "TNFRSF18")
FeaturePlot(immune_seurat, genes,  pt.size = 1)
ggsave(paste0(figure_dir, "UMAP_Tcell_activation.png"), width = 6, height = 6)

# T cell memory
genes <- c("SELL", "IL7R", "CD44")
FeaturePlot(immune_seurat, genes, pt.size = 1)
ggsave(paste0(figure_dir, "UMAP_Tcell_memory.png"), width = 6, height = 6)

# T cell TFs
genes <- c("TBX21", "STAT1", "RUNX3", "EOMES", "NFATC2", "PRDM1", "FOXP3", "STAT5A", "STAT5B", "RORA", "RORC", "STAT3")
FeaturePlot(immune_seurat, genes,  pt.size = 1)
ggsave(paste0(figure_dir, "UMAP_Tcell_tfs.png"), width = 12, height = 9)


immune_seurat$astrocyte1<-NULL; immune_seurat$cytotoxicity1<-NULL
```

## Based on above graphs, assign each cluster to T cell or Myeloid
```{r}
## Increase resolution to split off T cell cluster
immune_seurat<- FindClusters(immune_seurat, resolution = 2.5)

## Merge clusters- everything but 0/3 into single cluster
immune_seurat$seurat_clusters_merged<- ifelse(!immune_seurat$seurat_clusters %in% c(0,3), 2, immune_seurat$seurat_clusters)

## Vln plot of markers
VlnPlot(immune_seurat, group.by = "seurat_clusters_merged", features=c("CD3G", "CSF1R")) + 
  DimPlot(immune_seurat, group.by = "seurat_clusters_merged", label=TRUE)
ggsave(paste0(figure_dir, "Vln_BroadMarkers_byCluster.png"), width=8, height=8)

## Identify markers
immune_seurat<- SetIdent(immune_seurat, value=immune_seurat$seurat_clusters_merged)
markers<- FindAllMarkers(immune_seurat)
markers_filtered<- markers[markers$p_val_adj<0.05,]
top_markers<- markers_filtered %>% group_by(cluster) %>% top_n(n=10, wt=avg_log2FC) %>% as.data.frame()

## Set as tcell/myeloid
immune_seurat$broad_annot<- ifelse(immune_seurat$seurat_clusters_merged == 4, "Tcell", "Myeloid")
DimPlot(immune_seurat, group.by = "broad_annot")
ggsave(paste0(figure_dir, "broad_annot.png"), width=5, height=4)
```




## Split by Myeloid/T cell, rerun seurat pipeline for each separately
```{r}
## Split by broad annotation
myeloid_seurat<- subset(immune_seurat, broad_annot=="Myeloid")
tcell_seurat<- subset(immune_seurat, broad_annot=="Tcell")

## Save metadata for adding to seurat
myeloid_meta<- myeloid_seurat@meta.data; tcell_meta<- tcell_seurat@meta.data

## Run full seurat pipeline on myeloid/tcell separately
myeloid_seurat<- RunFullSeurat(myeloid_seurat@assays$RNA@counts, samples=myeloid_seurat$sampleid, RunHarmony = FALSE)
tcell_seurat<- RunFullSeurat(tcell_seurat@assays$RNA@counts, samples=tcell_seurat$sampleid, RunHarmony=FALSE,
                             pca_dims = 14,dims = 14,  n.neighbors = 14)


## Add metadata back
myeloid_seurat<- AddMetaData(myeloid_seurat, metadata=myeloid_meta[,!colnames(myeloid_meta) %in%
                                                                     colnames(myeloid_seurat@meta.data)])
tcell_seurat<- AddMetaData(tcell_seurat, metadata=tcell_meta[,!colnames(tcell_meta) %in% 
                                                               colnames(tcell_seurat@meta.data)])

## Save 
saveRDS(myeloid_seurat, file=paste0(analysis_dir, "myeloid_seurat.Rds"))
saveRDS(tcell_seurat, file=paste0(analysis_dir, "tcell_seurat.Rds"))
saveRDS(immune_seurat, file=paste0(analysis_dir, "tcell.myeloid_seurat.Rds"))
```




