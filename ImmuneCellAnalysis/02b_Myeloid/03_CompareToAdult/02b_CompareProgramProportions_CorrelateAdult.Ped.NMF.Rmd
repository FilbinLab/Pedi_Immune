---
title: "CompareProgramProportions.Rmd"
author: "Jenna LaBelle"
date: "11/11/2021"
output: html_document
---

## Purpose:
Identify programs that are SHARED between ped/adult myeloid cells and programs that are SPECIFIC to ped/adult. Compare changes to proportions of these programs between ped/adult

## Approach:
1. Correlate ped NMF programs with adult NMF programs- using the adult NMF with IDHmut/GBM run simultaneously
2. Use the correlation heatmap to identify shared and specific programs. For shared, merge genesets. Consider taking shared genes + top X genes from adult/ped
3. Score adult and ped myeloid cells for these shared and specific gene sets
4. Compare proportions of these programs in adult/ped

```{r}
library(Seurat) 
library(clusterProfiler)
library(biomaRt)
library(stringr)
library(ggpubr)

base_dir = "/Users/jlabelle/"
script_dir = "Dropbox (Partners HealthCare)/FilbinLab/data_analysis/Scripts/"
working_dir<- paste0(base_dir, 
                     "Dropbox (Partners HealthCare)/FilbinLab/",
                     "data_analysis/Projects/git_repos/Pedi_Immune/ImmuneCellAnalysis/02b_Myeloid/03_CompareToAdult/")

analysis_dir_tmp<- paste0(working_dir, "/analysis/CompareProgramProportions_CorrelateAdult.Ped.NMF/")
figure_dir_tmp<- paste0(working_dir, "/figures/CompareProgramProportions_CorrelateAdult.Ped.NMF/")
data_dir_tmp<- paste0("../../01_Preprocessing/02_Counts_Preprocess/analysis/detailed_annotation/")

if(!dir.exists(figure_dir_tmp)){dir.create(figure_dir_tmp)};if(!dir.exists(analysis_dir_tmp)){dir.create(analysis_dir_tmp)}

preprocessing = paste0(base_dir, script_dir, "single_cell_preprocessing_helper_functions.R")
nmf_helper = paste0(base_dir, script_dir, "NMF_helper_function.R")
source(preprocessing)
source(nmf_helper)

```

## Read in seurat objects + marker genes
```{r}
cohort<- "pedOnly_nomuv63"
ped_rank<-6 ## rank to use for ped
adult_rank<- 7

figure_dir<- paste0(figure_dir_tmp, cohort, "/"); analysis_dir<- paste0(analysis_dir_tmp, cohort, "/")
data_dir<- paste0(data_dir_tmp, cohort, "/")
if(!dir.exists(figure_dir)){dir.create(figure_dir)};if(!dir.exists(analysis_dir)){dir.create(analysis_dir)}

## ped seurat object
ped_seurat<-readRDS(paste0(data_dir, "myeloid_seurat_noDC.B.Rds"))

## adult (GBM and IDHmut; smartseq2)
load(paste0("../../01_Preprocessing/03_PreprocessAdultDatasets/", 
                                "analysis/Preprocess_AdultMyeloid/", "GBMNeftel_IDHmut2018_myeloid_merged_seurat.Robj"))
#adult_seurat<- gbm_idhmut_myeloid_seurat; rm(gbm_idhmut_myeloid_seurat)

## ped marker genes
ped_markers<- read.csv(paste0("../01a_NMF/analysis/de.novoNMF/", cohort,  "/top_DE_genes_10Xannotated_NMF_rank", ped_rank, ".csv"))
ped_markers<- ped_markers[,!grepl("X", colnames(ped_markers))]

## adult marker genes- for NMF run simultaneously for gbm/idhmut
adult_markers<- read.csv(paste0("../01b_Ped.Adult.NMF/analysis/AdultCohorts_DeNovoNMF/MergedNMF_GBM.Neftel_IDHmutScience2018_top_DE_genes_NMF_rank", 
                                adult_rank, ".csv"))
adult_markers<- adult_markers[,!grepl("X", colnames(adult_markers))]
```

## Merge and normalize count matrix
```{r}
## Merge count matrix
ped_cm<- ped_seurat@assays$RNA@counts; adult_cm<- adult_seurat@assays$RNA@counts
ped_cm<- ped_cm[rownames(adult_cm),]
sum(rownames(ped_cm) == rownames(adult_cm)); nrow(ped_cm); nrow(adult_cm)
cm<- cbind(ped_cm, adult_cm)

## Normalize/center merged count matrix
cm_list<- NormCenter(cm)
cm_mean<- rowMeans(log2(cm_list$raw_data + 1))
```

## Score ped/adult myeloid cells for ped/adult programs
```{r}
## create marker list
ped_marker_list<- split(ped_markers, f=ped_markers$cluster); ped_marker_list<- lapply(ped_marker_list, function(x){x$gene})
adult_marker_list<- split(adult_markers, f=adult_markers$cluster); adult_marker_list<- lapply(adult_marker_list, function(x){x$gene})
names(adult_marker_list)<- paste0("Adult_NMF", names(adult_marker_list))
marker_list<- c(ped_marker_list, adult_marker_list)

## score for marker list
scores<- as.data.frame(t(scoreNmfGenes(cm_list$center_data, cm_mean, marker_list)))
```

## Correlate scores
```{r}
## Correlate and plot heatmap
scores_factor_hc = clusterNmfFactors(scores)
scores_factor_cor = scores_factor_hc$cor_coef[scores_factor_hc$hc_obj$order, scores_factor_hc$hc_obj$order]

## Heatmap of correlations
hm_colors = rev((brewer.pal(n=9, name="RdBu")))
hm_colors = colorRampPalette(colors = hm_colors)
pheatmap(scores_factor_cor, color = hm_colors(100), 
         cluster_rows = F, cluster_cols = F, 
         annotation_names_row = F, annotation_names_col =T,
         show_rownames = T, show_colnames = F,
         filename = paste0(figure_dir, "Cor_Ped.rank", ped_rank,"_Adult.rank", adult_rank,  ".png"),
         width = 8, height = 4)

## Dendrogram of hierarchical clustering 
jpeg(filename=paste0(figure_dir, "HC_Ped.rank", ped_rank,"_Adult.rank", adult_rank,  ".png"), width = 400, height = 600)
plot(scores_factor_hc$hc_obj)
dev.off()
```


## Gene overlap between ped/adult
```{r}
library(ggVennDiagram)

cohort<- "pedOnly_nomuv63"
ped_rank<-6 ## rank to use for ped
adult_rank<- 5

## ped marker genes
ped_markers<- read.csv(paste0("../01a_NMF/analysis/de.novoNMF/", cohort,  "/top_DE_genes_10Xannotated_NMF_rank", ped_rank, ".csv"))
ped_markers<- ped_markers[,!grepl("X", colnames(ped_markers))]


## adult marker genes- for NMF run simultaneously for gbm/idhmut
adult_markers<- read.csv(paste0("../01b_Ped.Adult.NMF/analysis/AdultCohorts_DeNovoNMF/MergedNMF_GBM.Neftel_IDHmutScience2018_top_DE_genes_NMF_rank", 
                                adult_rank, ".csv"))
adult_markers<- adult_markers[,!grepl("X", colnames(adult_markers))]

## create marker list
ped_marker_list<- split(ped_markers, f=ped_markers$cluster); ped_marker_list<- lapply(ped_marker_list, function(x){x$gene})
adult_marker_list<- split(adult_markers, f=adult_markers$cluster); adult_marker_list<- lapply(adult_marker_list, function(x){x$gene})
names(adult_marker_list)<- paste0("Adult_NMF", names(adult_marker_list))

## For each ped program: venn diagram with adult program with highest gene overlap
nGenesAdult<- unlist(lapply(adult_marker_list, length))
all_plots<- lapply(names(ped_marker_list), function(x){
  ped_markers<- ped_marker_list[[x]]
  inAdult<- sapply(adult_marker_list, function(x){sum(x %in% ped_markers)})/nGenesAdult
  maxPropAdult<- names(inAdult)[which.max(inAdult)]
  ggVennDiagram(list(ped=ped_markers, adult=adult_marker_list[[maxPropAdult]]))+
    scale_fill_gradient(low="white", high="red")+
    scale_color_manual(values = rep("black", 3))+
    ggtitle(paste0("Ped: ", x, "\nMax adult: ", maxPropAdult))
})
cowplot::plot_grid(plotlist=all_plots)
ggsave(paste0(figure_dir, "Venn_PedRank", ped_rank, "_withMaxOverlapAdultRank", adult_rank, ".png"), width=9, height=6)
```

