---
title: "AdultGBM10X_AnnotatePed.Rmd"
output: html_document
date: "11/11/2021"
---

## Purpose:
Use adult GBM 10X dataset to help annotate Ped Myeloid NMF programs

## Approach:
Score ped myeloid cells for both adult GBM 10x programs + ped NMF programs, correlate to help annotate ped NMF programs. These programs are generated by me from Adult GBM 10x- assigned all cells as mg/mo/cycling/monocyte, findAllMarkers

```{r}
base_dir = "/Users/jlabelle/"
script_dir = "Dropbox (Partners HealthCare)/FilbinLab/data_analysis/Scripts/"
working_dir<- paste0(base_dir, 
                     "Dropbox (Partners HealthCare)/FilbinLab/",
                     "data_analysis/Projects/git_repos/Pedi_Immune/ImmuneCellAnalysis/02b_Myeloid/02_AdditionalAnnotation/")

data_dir_tmp<- paste0("../../01_Preprocessing/02_Counts_Preprocess/analysis/detailed_annotation/")


preprocessing = paste0(base_dir, script_dir, "single_cell_preprocessing_helper_functions.R")
source(preprocessing)

integration<- "" ## HarmonyInt/ or ""
figure_dir_tmp<- paste0("figures/GBM.10X_Mg.Mo.Mono/",integration)
analysis_dir_tmp<- paste0("analysis/BM.10X_Mg.Mo.Mono/", integration)

for(i in c(figure_dir_tmp, analysis_dir_tmp)){
  if(!dir.exists(i)){dir.create(i, recursive = TRUE)}
}

preprocessing = paste0(base_dir, script_dir, "single_cell_preprocessing_helper_functions.R")
source(preprocessing)
nmf_helper = paste0(base_dir, script_dir, "NMF_helper_function.R")
source(nmf_helper)
```


## Load in ped seurat + adult markers
```{r}
cohort<- "pedOnly_nomuv63"
analysis_dir<- paste0(analysis_dir_tmp, cohort, "/")
figure_dir<- paste0(figure_dir_tmp, cohort, "/")
data_dir<- paste0(data_dir_tmp,integration, cohort, "/")


for(i in c(figure_dir, analysis_dir)){
  if(!dir.exists(i)){dir.create(i, recursive = TRUE)}
}

## Can use harmony integration JUST for visualization purposes- annotations + programs are all from original, non-integrated analysis
## Set this to "_harmony" or ""
use_harmony_forVis<- "_harmony"
if(use_harmony_forVis=="_harmony"){
  figure_dir<- paste0(figure_dir, "Harmony/"); if(!dir.exists(figure_dir)){dir.create(figure_dir)}
  }

## Load in adult gene lists (preprocessed in Preprocess_AdultMyeloid.Rmd)
adult_markers_top100<- readRDS(paste0("../../01_Preprocessing/03_PreprocessAdultDatasets/", 
                                      "analysis/Preprocess_AdultMyeloid/", 
                                      "GBM.10X_recurrent_mg.mo.monocyte.prol_markers_top100.Rds"))
adult_myeloid_markers<- split(adult_markers_top100, f=adult_markers_top100$cluster)
adult_myeloid_markers<- lapply(adult_myeloid_markers, function(x){x$gene})
names(adult_myeloid_markers)<- paste0("Adult_", names(adult_myeloid_markers))

## Remove proliferating
adult_myeloid_markers<- adult_myeloid_markers[names(adult_myeloid_markers) != "Adult_prol_TAM"]


## load ped myeloid seurat object- without DC or B cells
myeloid_seurat<- readRDS(paste0(data_dir, "myeloid_seurat_noDC.B", use_harmony_forVis,".Rds"))

## Center/mean ped myeloid
ped_cm_list<- NormCenter(myeloid_seurat@assays$RNA@counts)
ped_cm_mean<- rowMeans(log2(myeloid_seurat@assays$RNA@counts + 1))
```



## score cells 
```{r}
## score
scores<- as.data.frame(t(scoreNmfGenes(ped_cm_list$center_data, ped_cm_mean,  
                                                   c(adult_myeloid_markers))))
scores$MaxProgram<- apply(scores, 1, function(x){names(x)[which.max(x)]})
scores$MaxScore<- apply(scores[,colnames(scores) != "MaxProgram"], 1, function(x){x[which.max(x)]})

## Add to seurat object
myeloid_seurat$MgMoMonocyte_annot<- plyr::mapvalues(colnames(myeloid_seurat), rownames(scores), scores$MaxProgram)
myeloid_seurat$MgMoMonocyte_score<- plyr::mapvalues(colnames(myeloid_seurat), rownames(scores), scores$MaxScore)


## Plot by max program
colors_use<- c(Adult_Monocytes="turquoise3", Adult_Mg_TAM="blue", Adult_Mo_TAM="red")
DimPlot(myeloid_seurat, group.by = "MgMoMonocyte_annot")+
  scale_color_manual(values=colors_use)
ggsave(paste0(figure_dir, "UMAP_MaxProgram.png"), width=6, height=4.5)

## Plot each program one at a time
seurat_tmp<- myeloid_seurat
all_plots<- lapply(as.character(unique(myeloid_seurat$MgMoMonocyte_annot)), function(x){
  seurat_tmp$tmp<- ifelse(myeloid_seurat$MgMoMonocyte_annot==x,
                          x, "Other")
  p<-DimPlot(seurat_tmp, group.by = "tmp")+scale_color_manual(values=c(colors_use, Other="grey"))+ggtitle(x)+NoLegend()
  return(p)
})
cowplot::plot_grid(plotlist=all_plots, ncol = 2)
ggsave(paste0(figure_dir, "UMAP_indv_annot_rank", rank_use, ".png"), width=6, height=6)

## Save with mg/mo/monocyte/prol annotation
saveRDS(myeloid_seurat, file=paste0(data_dir, "myeloid_seurat_noDC.B", use_harmony_forVis,".Rds"))
```

## Plot proportion of mgTAM / moTAM / Monocytes / prol_TAM per program
```{r}
## Make df of cell types per program
program_bd<- as.data.frame(table(myeloid_seurat$NMF_rank6_annotByAdult10X,
                                 myeloid_seurat$MgMoMonocyte_annot))
colnames(program_bd)<- c("Program", "CellType", "Ncells")

## Convert to percentage
program_bd <- program_bd %>% group_by(Program) %>% mutate(PerCells=Ncells/sum(Ncells)) %>% as.data.frame()

## Plot
colors_use<- c(Adult_Monocytes="turquoise3", Adult_Mg_TAM="blue", Adult_Mo_TAM="red")
ggplot(program_bd, aes(x=Program, y=PerCells, fill=CellType))+
  geom_bar(stat="identity", position="stack")+
  theme_classic()+
  scale_fill_manual(values=colors_use)+
  theme(axis.text.x = element_text(angle=45, hjust=1),
        axis.text = element_text(face="bold", color="black"),
        axis.title = element_text(face="bold", color="black"))+
  ylab("Proportion of cells\nannotated as cell type")+xlab("")
ggsave(paste0(figure_dir, "ProportionOfCellType_perProgram.png"), width=5, height=4)

```

## Plot scores by program
```{r}
## Add on scores
myeloid_seurat<- AddMetaData(myeloid_seurat, scores[,!grepl("Max", colnames(scores))])

## Plot by program
VlnPlot(myeloid_seurat, 
        features=colnames(scores)[!grepl("Max", colnames(scores))],
        group.by = "NMF_rank6byScore_annotByAdult10X", ncol=2,
        cols = c(SEPP1_Mo_TAM ="orange", Inflammatory="red", IFN_TAM="purple", Stress_Response="olivedrab4",
                            Monocytes="turquoise3", Hypoxic_TAM="navy"), sort=TRUE)
```

## Histogram of program scores, colored by mg_tam/mo_tam distinction
```{r}
colors_use<- c(Adult_Monocytes="turquoise3", Adult_Mg_TAM="blue", Adult_Mo_TAM="red")

## Read in scores for programs
rank_use<- 6
all_scores<- readRDS(paste0("../01a_NMF/analysis/de.novoNMF/",cohort,
                            "/NMF_scores_annotByAdult10X_rank6-6", ".Rds"))
scores<- all_scores[[paste0("rank", rank_use)]]
programs<- c("Inflammatory", "IFN_TAM",  "Monocytes", "Stress_Response" ,"SEPP1_Mo_TAM","Hypoxic_TAM")

## Add on max mo_tam/mg_tam
scores$MM_annot<- plyr::mapvalues(rownames(scores), colnames(myeloid_seurat), myeloid_seurat$MgMoMonocyte_annot)


## plot
all_plots<- lapply(programs, function(x){
  df<- scores[,c(x, "MM_annot")]
  colnames(df)<- c("ProgramScore", "MM_annot")
  p<- ggplot(df, aes(x=ProgramScore, fill=MM_annot))+
    geom_histogram()+
    theme_bw()+
    scale_fill_manual(values=colors_use)+
    ggtitle(x)+
    theme(axis.title = element_text(face="bold", color="black"),
          axis.text = element_text(face="bold", color="black"),
          title = element_text(face="bold", color="black"))
    return(p)
})

cowplot::plot_grid(plotlist=all_plots, ncol=2)
ggsave(paste0(figure_dir, "Histogram_ProgramScores.png"), width=10, height=9)
```

## Density plots
```{r}
colors_use<- c(Adult_Monocytes="turquoise3", Adult_Mg_TAM="blue", Adult_Mo_TAM="red")

## Read in scores for programs
rank_use<- 6
all_scores<- readRDS(paste0("../01a_NMF/analysis/de.novoNMF/",cohort,
                            "/NMF_scores_annotByAdult10X_rank6-6", ".Rds"))
scores<- all_scores[[paste0("rank", rank_use)]]
programs<- colnames(scores[!grepl("Max", colnames(scores))])


## Create df for plotting
myeloid_df<-myeloid_seurat@meta.data[,c("sampleid", "MgMoMonocyte_annot", paste0("NMF_rank", rank_use, "_annotByAdult10X"))]
sum(rownames(scores)==rownames(myeloid_df)); nrow(scores); nrow(myeloid_df)
myeloid_df<- cbind(myeloid_df, scores[,!grepl("Max", colnames(scores))] )


myeloid_df$MgMoMonocyte_annot<- factor(myeloid_df$MgMoMonocyte_annot, 
                                          levels=c("Adult_prol_TAM", "Adult_Monocytes", "Adult_Mg_TAM", "Adult_Mo_TAM"))

## Plot each nmf program
all_plots<- list()
programs<- as.character(unique(myeloid_seurat@meta.data[[paste0("NMF_rank", rank_use, "_annotByAdult10X")]]))
for(i in programs){
  df<- myeloid_df[,c(as.character(i), "MgMoMonocyte_annot")]
  colnames(df)<- c("score", "CellType")
  p<-ggplot(df, aes(x=score, fill=CellType))+
    geom_density(alpha=0.6)+
    ggtitle(i)+
    scale_fill_manual(values=colors_use)+
    theme_classic()+
    theme(legend.title = element_blank(),
          legend.position = "none",
          plot.title = element_text(size=20, face="bold", hjust=0.5))

  all_plots[[i]]<-p
}

## add legend separately
legend<-ggplot(df, aes(x=score, fill=CellType))+
    geom_density(alpha=0.6)+
    ggtitle(i)+
    scale_fill_manual(values=colors_use)+
    theme_classic()+
    theme(legend.title = element_blank(),
          legend.key.size = unit(1.5, 'cm'),
          legend.text = element_text(size=20))
all_plots$legend<-  as_ggplot(get_legend(legend))
all_plots<- all_plots[c(1:3,7,4:6)]
cowplot::plot_grid(plotlist = all_plots, ncol=4)

ggsave(paste0(figure_dir, "DensityOfNMFByMgMoMonocytes_rank", rank_use,".pdf"), device="pdf", width=20, height=8)

## KS test comparing Mg vs Mo for each program (not sure if you can do a 3 variable test with KS?)
sapply(colnames(myeloid_df)[4:9], function(x){
  print(x)
  ks.test(myeloid_df[,x][myeloid_df$MgMoMonocyte_annot=="Adult_Mg_TAM"],
        myeloid_df[,x][myeloid_df$MgMoMonocyte_annot=="Adult_Mo_TAM"])
})


```


## For each program, subset to cells scoring highest for that program. Then plot their Mg_TAM vs their Mo_TAM scores
```{r}
## Read in scores for programs
rank_use<- 6
all_scores<- readRDS(paste0("../01a_NMF/analysis/de.novoNMF/",cohort,
                            "/NMF_scores_annotByAdult10X_rank6-6", ".Rds"))
scores<- all_scores[[paste0("rank", rank_use)]]
programs<- c("Inflammatory",  "Monocytes","SEPP1_Mo_TAM",  "IFN_TAM","Stress_Response" ,"Hypoxic_TAM")

colors_use<-c("purple","turquoise3", "red", "orange", "navy", "olivedrab4", "grey22"  )
names(colors_use)<- as.character(unique(myeloid_seurat@meta.data[[paste0("NMF_rank", rank_use, "_annotByAdult10X")]]))

## Add on microglia/macrophage score
scores$Mg_TAM_score<- as.numeric(plyr::mapvalues(rownames(scores),colnames(myeloid_seurat), myeloid_seurat$Mg_TAM_score))
scores$Mo_TAM_score<- as.numeric(plyr::mapvalues(rownames(scores),colnames(myeloid_seurat), myeloid_seurat$Mo_TAM_score))

## cycle through each program, subset to those cells, plot moTAM vs MgTAM
all_plots<- lapply(programs, function(x){
  df<- scores[scores$MaxProgram==x, c("Mg_TAM_score", "Mo_TAM_score")]
  ggplot(df, aes(x=Mg_TAM_score, y=Mo_TAM_score))+
    geom_point(color=colors_use[x])+
    theme_bw()+
    ggtitle(x)+
    ylim(-3,3)+xlim(-2,3)+
    theme(axis.title = element_text(face="bold", color="black"),
          axis.text = element_text(face="bold", color="black"),
          title = element_text(face="bold", color="black"))+
    geom_hline(yintercept = 0)+geom_vline(xintercept = 0)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir, "MgTAM.vs.MoTAM_scores_ByMaxNMFProgram.png"), width=9, height=6)
```

## Overlap of gene sets with microglia/macrophage
```{r}
library(ggVennDiagram)

## Read in microglia/macrophage genesets
gene_set_dir<- "../../../../../../Shared/Marker_genes/"
microglia_genes = read.table(paste0(gene_set_dir, "Microglia_markers.txt"))
macrophage_genes = read.table(paste0(gene_set_dir, "Macrophage_markers.txt"))
tam_genes = list("microglia" = microglia_genes$V1, "macrophage" = macrophage_genes$V1)

p1<- ggVennDiagram(list(Microglia=tam_genes$microglia, Mg_TAM=adult_myeloid_markers$Adult_Mg_TAM))+
  scale_fill_gradient(low="white", high="red")+
  scale_color_manual(values=c("black", "black"))+
  theme(legend.position = "none")

p2<- ggVennDiagram(list(Macrophage=tam_genes$macrophage, Mo_TAM=adult_myeloid_markers$Adult_Mo_TAM))+
  scale_fill_gradient(low="white", high="red")+
  scale_color_manual(values=c("black", "black"))+
  theme(legend.position = "none")

p1+p2
ggsave(paste0(figure_dir, "VennDiagram_overlapWithMicroglia.Macrophage_genesets.png"), width =6, height=2.5)
```


