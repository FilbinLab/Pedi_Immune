---
title: "R Notebook"
output: html_document
---

Run CellChat according to "standard" vignette (https://htmlpreview.github.io/?https://github.com/sqjin/CellChat/blob/master/tutorial/CellChat-vignette.html#part-ii-inference-of-cell-cell-communication-network)

For other CelLChat analyses, each pairwise comparison (e.g., Cytotoxic vs Memory) is run separately. This allows for identification of LRs that are not necessarily specific to that pair, which may be better for L/R identification. However, the standard approach, while it may leave out some of these non-specific LRs, may be better for looking at overall interaction networks.

Here, the standard approach is modified slightly- cellchat run separately for each sample (but still simultaneously for all programs)

```{r}
library(CellChat)
library(Seurat) 

options(stringsAsFactors = FALSE)

base_dir = "/Users/jlabelle/"
script_dir = "Dropbox (Partners HealthCare)/FilbinLab/data_analysis/Shared/Scripts/"
working_dir<- paste0(base_dir, 
                     "Dropbox (Partners HealthCare)/FilbinLab/",
                     "data_analysis/Projects/git_repos/Pedi_Immune/ImmuneCellAnalysis/04a_Integrate_Immune.Tumor/CellChat/")


analysis_dir<- paste0(working_dir, "/analysis/standardCellChat_bySample/")
figure_dir<- paste0(working_dir, "/figures/standardCellChat_bySample/")
for(i in c(analysis_dir, figure_dir)){if(!dir.exists(i)){dir.create(i)}}


cellchatHelper<- paste0(base_dir, script_dir, "CellChat_HelperFunctions.R")
source(cellchatHelper)

setwd(working_dir)
```

## Load seurat object list
```{r}
seurat_obj_list<- readRDS("analysis/seurat_list_bySample.Rds")

## Remove unclear t cells
seurat_obj_list<- lapply(seurat_obj_list, function(seurat_obj){
  subset(seurat_obj, immunePrograms_tumorCellTypes != "Unclear_IFN.Response")
})



## Add detailed annot
seurat_obj_list<- lapply(seurat_obj_list, function(seurat_obj){
  seurat_obj$detailed_annot<- ifelse(grepl("CD4", seurat_obj$detailed_annotForCellChat), "CD4",
                                     ifelse(grepl("CD8", seurat_obj$detailed_annotForCellChat), "CD8",
                                            ifelse(seurat_obj$detailed_annotForCellChat=="Myeloid", "Myeloid", "Tumor")))
  return(seurat_obj)
})


## Set simplified programs- remove lowly present tumor cell populations
seurat_obj_list_use<- lapply(seurat_obj_list, function(seurat_obj){
  nCells<- table(seurat_obj$immunePrograms_tumorCellTypes)
  programs_use<-names(nCells)[nCells>=10]
  seurat_use<- subset(seurat_obj, immunePrograms_tumorCellTypes %in% programs_use)
  return(seurat_use)
})

## set metadata column to use downstream
meta_use<- "detailed_annot"

## Set seurat object to use downstream
if(meta_use=="immunePrograms_tumorCellTypes"){
  seurat_obj_list_use<- seurat_obj_list_use
}else{seurat_obj_list_use<- seurat_obj_list}
seurat_obj_list_use<- lapply(seurat_obj_list, function(seurat_use){
  seurat_use$meta_use<-seurat_use@meta.data[[meta_use]]
  return(seurat_use)
})

## Set cell types
programs<-unique(unlist(lapply(seurat_obj_list, function(x){x$immunePrograms_tumorCellTypes})))
cd4_types<- programs[grepl("CD4", programs)]
cd8_types<- programs[grepl("CD8", programs)]
myeloid_types<- c("IFN_TAM", "Monocytes", "Inflammatory", "Hypoxic_TAM", "Stress_Response", "SEPP1_Mo_TAM")
tumor_types<-programs[!programs %in% c(cd4_types, cd8_types, myeloid_types)]
cell_types<- list(CD4=cd4_types, CD8=cd8_types, Myeloid=myeloid_types, Tumor=tumor_types)
```

## Run cellchat split by sample
This section run on O2
```{r}
## Subset to samples with at least 2 groups
tmp<-lapply(seurat_obj_list_use, function(x){table(x$meta_use)})
seurat_obj_list_use<- seurat_obj_list_use[lapply(tmp, function(x){length(x)}) > 1]

## Create cellchat object
cellchat_list<- lapply(seurat_obj_list_use, function(seurat_use){
  cellchat <- createCellChat(object = seurat_use@assays$RNA@data, 
                           meta = seurat_use@meta.data, 
                           group.by = "meta_use")
  return(cellchat)
})


## Set database
cellchat_list<- lapply(cellchat_list, function(cellchat){
  cellchat@DB <-CellChatDB.human 
  return(cellchat)
})


# subset the expression data of signaling genes for saving computation cost
cellchat_list<- lapply(cellchat_list, function(cellchat){
  return(subsetData(cellchat))
})

## Find overexpressed genes
cellchat_list<- lapply(cellchat_list, function(cellchat){
  identifyOverExpressedGenes(cellchat)
})

cellchat_list<- lapply(cellchat_list, function(cellchat){
  identifyOverExpressedInteractions(cellchat)
})

## Compute the communication probability and infer ce llular communication network
cellchat_list<- lapply(names(cellchat_list), function(sample){
    message(sample)
    cellchat<- cellchat_list[[sample]]
   computeCommunProb(cellchat)
})
names(cellchat_list)<- names(seurat_obj_list_use)

cellchat_list<- lapply(cellchat_list, function(cellchat){
  filterCommunication(cellchat, min.cells = 10)
})

## Infer the cell-cell communication at a signaling pathway level
message("Infer the cell-cell communication at a signaling pathway level")
cellchat_list<- lapply(cellchat_list, function(cellchat){
  computeCommunProbPathway(cellchat)
})


## Calculate the aggregated cell-cell communication network
message("Calculate the aggregated cell-cell communication network")
cellchat_list<- lapply(cellchat_list, function(cellchat){
  aggregateNet(cellchat)
})
saveRDS(cellchat_list, file=paste0(analysis_dir, "standardCellChat_res_by", meta_use,".Rds")) 

## Extract results
message("Extract results")
PathwaysRemove<-c("HLA", "COL", "LAMININ", "MHC-I")
sigLRs_list<- lapply(names(cellchat_list), function(sample){
  cellchat<- cellchat_list[[sample]]
  if(length(cellchat@netP$pathways)>1){
    sigLRs<-  subsetCommunication(cellchat, thresh = 1)
    sigLRs<- sigLRs[!sigLRs$pathway_name %in% PathwaysRemove,]
    return(sigLRs)
  }else{print(paste0("No LRs for ", sample)); return(NULL)}
})
names(sigLRs_list)<-names(cellchat_list)
sigLRs_list<- sigLRs_list[unlist(lapply(sigLRs_list, function(x){!is.null(x)}))]


## Add major cell type to LRs (when running by program)
if(meta_use=="immunePrograms_tumorCellTypes"){
  sigLRs_list<- lapply(sigLRs_list, function(sigLRs){
    sigLRs$major_sender<- sapply(sigLRs$source, function(x){names(cell_types[unlist(lapply(cell_types, function(y){x %in% y}))])})
    sigLRs$major_receiver<- sapply(sigLRs$target, function(x){names(cell_types[unlist(lapply(cell_types, function(y){x %in% y}))])})
    return(sigLRs)
})
} else{
  sigLRs_list<- lapply(sigLRs_list, function(sigLRs){
    sigLRs$major_sender<-sigLRs$source; sigLRs$major_receiver<- sigLRs$target
    return(sigLRs)
  })
}


## Add on sample and collapse to DF
sigLRs_list<- lapply(names(sigLRs_list), function(sample){
  tmp<- sigLRs_list[[sample]]
  tmp$sample<- sample
  return(tmp)
})
sigLRs_df<- do.call("rbind", sigLRs_list)



write.csv(sigLRs_df, file=paste0(analysis_dir, "standardCellChat_sigLRs_by",meta_use, ".csv" ))

```

## Load in cellchat results and plot
```{r}
## Load LRs
meta_use<- "immunePrograms_tumorCellTypes"
sigLRs<- read.csv(paste0(analysis_dir, "standardCellChat_sigLRs_by",meta_use, ".csv" ), row.names = "X")

## Subset to sig
sigLRs<- sigLRs[sigLRs$pval<0.1,]

## subset to unique LRs in pair
sigLRs$UniqueID<- paste0(sigLRs$source, ".to.", sigLRs$target, "_", sigLRs$interaction_name)
sigLRs<- sigLRs[!duplicated(sigLRs$UniqueID),]

## Get number of interactions per pair
bd<- as.data.frame(table(sigLRs$source, sigLRs$target))
colnames(bd)<- c("sender", "receiver", "nLR")

## Add major sender/receiver
bd$major_sender<- as.character(plyr::mapvalues(bd$sender, sigLRs$source, sigLRs$major_sender, warn_missing = FALSE))
bd$major_receiver<- as.character(plyr::mapvalues(bd$receiver, sigLRs$target, sigLRs$major_receiver, warn_missing = FALSE))


sigLRs_plot<- bd

## Order cell types by major cell type
ordered_celltypes<- gsub("\n", "_", c(cd4_types, cd8_types, myeloid_types, tumor_types))
sigLRs_plot$receiver.plot<- factor(sigLRs_plot$receiver, levels=ordered_celltypes[ordered_celltypes %in% sigLRs_plot$receiver])
sigLRs_plot$sender.plot<- factor(sigLRs_plot$sender, levels=ordered_celltypes[ordered_celltypes %in% sigLRs_plot$sender])
#sigLRs_plot$major_sender<- gsub("CD4", "Immune", gsub("CD8", "Immune",gsub("Myeloid", "Immune", sigLRs_plot$major_sender)))


## Remove interactions between tumor cells
sigLRs_plot<- sigLRs_plot[!(sigLRs_plot$major_sender=="Tumor" & sigLRs_plot$major_receiver=="Tumor"),]


## heatmap
ggplot(sigLRs_plot, aes(x=sender, y=receiver, fill=nLR))+
  geom_tile()+
  scale_fill_gradient2(low="purple", mid ="white", high="yellow", midpoint = 20)+
  theme(axis.text.x = element_text(angle=45, hjust=1))+
  facet_grid(rows=vars(major_receiver),cols=vars(major_sender), space="free", scales = "free")+
  geom_text(aes(label = nLR))
ggsave(paste0(figure_dir, "nSigLRs_by", meta_use, ".png"), width=12, height=8)

## sankey
## Plot with my helper function
sr_pairs<- list(list(c("CD4", "CD8"), c("Tumor")),
                list(c("CD4", "CD8"), c("Myeloid")),
                list(c("Myeloid"), c("Tumor")))
sigLRs_plot$nLRs_norm<- sigLRs_plot$nLR
all_plots<- lapply(sr_pairs, function(p){
  tmp<- sigLRs_plot[(sigLRs_plot$major_receiver %in% p[[1]] & sigLRs_plot$major_sender %in% p[[2]]) |
                    (sigLRs_plot$major_receiver %in% p[[2]] & sigLRs_plot$major_sender %in% p[[1]]), ]
  tmp$major_receiver<- gsub("CD4", "Immune", gsub("CD8", "Immune", tmp$major_receiver))
  tmp$major_sender<- gsub("CD4", "Immune", gsub("CD8", "Immune", tmp$major_sender))
  my_sankeyPlot(tmp)
})
cowplot::plot_grid(plotlist=all_plots, ncol=3)
ggsave(paste0(figure_dir, "Sankey_LRs.png"), width=30, height=25)

```

