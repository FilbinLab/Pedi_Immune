---
title: "R Notebook"
output: html_document
---

## Purpose:
Overall goal is to compare tcells in melanoma and NSCLC (known to have reasonably good response to checkpoint therapies) to tcells in gliomas. Here, merge processed melanoma/NSCLC tumor cd8 with glioma, compare GOI expression patterns, breakdown of cell types

## Approach:
Merge processed melanoma/NSCLC tumor cd8 seurat object with glioma cd8 seurat object. Plot GOI in equivalent programs, plot breakdown of cell types

```{r}
library(Seurat) 
library(harmony)

base_dir = "/Users/jlabelle/"
script_dir = "Dropbox (Partners HealthCare)/FilbinLab/data_analysis/Scripts/"
working_dir<- paste0(base_dir, 
                     "Dropbox (Partners HealthCare)/FilbinLab/",
                     "data_analysis/Projects/git_repos/Pedi_Immune/ImmuneCellAnalysis/", 
                     "02a_Tcells/02_Ped.Adult/04b_ComparisonToOtherTumor/")

analysis_dir<- paste0(working_dir, "/analysis/NSCLC.melanoma/")
figure_dir<- paste0(working_dir, "/figures/Merge_NSCLC.Glioma.melanoma/")

if(!dir.exists(figure_dir)){dir.create(figure_dir,recursive = TRUE)}
if(!dir.exists(analysis_dir)){dir.create(analysis_dir, recursive = TRUE)}

preprocessing = paste0(base_dir, script_dir, "single_cell_preprocessing_helper_functions.R")
nmf_helper = paste0(base_dir, script_dir, "NMF_helper_function.R")
source(preprocessing)
source(nmf_helper)

```

## Read in seurat objects + marker genes
```{r}
rank_use<-8
sharedBy<- "union" 
data_dir<- paste0("../02_detailed_annot/analysis/identifyCD4.CD8_byNMF/", "rank",rank_use, "_sharedBy", sharedBy, "/" )

## Read in seurat objects
nsclc_cd8<- readRDS("analysis/NSCLC/cd8_seurat_nsclc.Rds")
glioma_cd8<- readRDS(paste0(data_dir, "ped.adult_seurat_cd8_harmony.Rds")) 
melanoma_cd8<- readRDS("analysis/melanoma/cd8_seurat_melanoma.Rds")

nsclc_cd4<- readRDS("analysis/NSCLC/cd4_seurat_nsclc.Rds")
glioma_cd4<- readRDS(paste0(data_dir, "ped.adult_seurat_cd4_harmony.Rds")) 
melanoma_cd4<- readRDS("analysis/melanoma/cd4_seurat_melanoma.Rds")

## May remove this- no programs for melanoma
  ## Read in marker genes for programs
  nsclc_cd8_markers<- read.csv(paste0(analysis_dir, "nsclc_cd8_cluster_markers_annot.csv"))
  glioma_markers<- readRDS(paste0("../01_compare_NMF/analysis/newMarkers_deNovoPed.AdultTcell/", 
                                   "new_markers_NMFrank", rank_use, "_bySeurat_sharedBy", sharedBy, "_reAnnot.Rds"))
  
  nsclc_cd4_markers<- read.csv(paste0(analysis_dir, "nsclc_cd4_cluster_markers_annot.csv"))
  
## Read in colors to use- add on nsclc-specific programs
  program_colors<- readRDS(paste0("../../../plot_colors/Tcell.programs_rank", rank_use, "sharedBy", sharedBy, "_reAnnot.Rds"))
  program_colors<- c(program_colors, CD28="pink", Naive="skyblue4", MAIT="brown", Predysfunctional.2="lightsalmon1",
                     Dysfunctional="violetred")
  program_colors<-c(program_colors, CD69="pink", GZMA="brown",ANXA1="lightsalmon3", ActivatedTreg="gold")
  program_colors<- c(program_colors, M0="grey", M1="grey", M2="grey", M3="grey", M4="grey", M5="grey")
```


## Merge seurat objects
```{r}
## CD8
  ## Check that scale is equivalent
  head(colSums(nsclc_cd8@assays$RNA@counts))/head(colSums(glioma_cd8@assays$RNA@counts))
  head(colSums(melanoma_cd8@assays$RNA@counts))/head(colSums(glioma_cd8@assays$RNA@counts))
  
  ## Match metadata
  nsclc_cd8$cellAnnot<- nsclc_cd8$majorCluster_annot
  glioma_cd8$cellAnnot<- glioma_cd8@meta.data[[paste0("NMF_rank", rank_use, "_annot_mergedBy", sharedBy, "_reAnnot")]]
  melanoma_cd8$cellAnnot<- paste0("M", melanoma_cd8$seurat_clusters) ## clusters
  nsclc_cd8$NiceSubtype<- "NSCLC"
  melanoma_cd8$NiceSubtype<- "Melanoma"
  nsclc_cd8$TumorType<- "NSCLC"
  glioma_cd8$TumorType<- "Glioma"
  melanoma_cd8$TumorType<- "Melanoma"
  
  glioma_cd8@meta.data<- glioma_cd8@meta.data[,colnames(glioma_cd8@meta.data) %in% colnames(nsclc_cd8@meta.data)]
  nsclc_cd8@meta.data<- nsclc_cd8@meta.data[,colnames(nsclc_cd8@meta.data) %in% colnames(glioma_cd8@meta.data)]
  melanoma_cd8@meta.data<- melanoma_cd8@meta.data[,colnames(melanoma_cd8@meta.data) %in% colnames(glioma_cd8@meta.data)]
  
  ## Merge seurat
  merge_cd8<- merge(nsclc_cd8, c(glioma_cd8, melanoma_cd8))
  
  ## Rerun clustering
  merge_cd8_meta<- merge_cd8@meta.data
  merge_cd8<- RunFullSeurat(merge_cd8@assays$RNA@counts, RunHarmony = TRUE, samples = merge_cd8_meta$sample)
  merge_cd8<- AddMetaData(merge_cd8, merge_cd8_meta[,!colnames(merge_cd8_meta) %in% colnames(merge_cd8@meta.data)])
  
  saveRDS(merge_cd8, file=paste0(analysis_dir, "cd8_seurat_nsclc.glioma.melanoma.Rds"))
  
## CD4
  ## Check that scale is equivalent
  head(colSums(nsclc_cd4@assays$RNA@counts))/head(colSums(glioma_cd4@assays$RNA@counts))
  head(colSums(melanoma_cd4@assays$RNA@counts))/head(colSums(glioma_cd4@assays$RNA@counts))
  
  ## Match metadata
  nsclc_cd4$cellAnnot<- nsclc_cd4$majorCluster_annot
  glioma_cd4$cellAnnot<- glioma_cd4@meta.data[[paste0("NMF_rank", rank_use, "_annot_mergedBy", sharedBy, "_reAnnot")]]
  melanoma_cd4$cellAnnot<- paste0("M", melanoma_cd4$seurat_clusters) ## just seurat clusters
  nsclc_cd4$NiceSubtype<- "NSCLC"
  melanoma_cd4$NiceSubtype<- "Melanoma"
  nsclc_cd4$TumorType<- "NSCLC"
  glioma_cd4$TumorType<- "Glioma"
  melanoma_cd4$TumorType<- "Melanoma"
  
  glioma_cd4@meta.data<- glioma_cd4@meta.data[,colnames(glioma_cd4@meta.data) %in% colnames(nsclc_cd4@meta.data)]
  nsclc_cd4@meta.data<- nsclc_cd4@meta.data[,colnames(nsclc_cd4@meta.data) %in% colnames(glioma_cd4@meta.data)]
  melanoma_cd4@meta.data<- melanoma_cd4@meta.data[,colnames(melanoma_cd4@meta.data) %in% colnames(glioma_cd4@meta.data)]
  
  ## Merge seurat
  merge_cd4<- merge(nsclc_cd4, c(glioma_cd4, melanoma_cd4))
  
  ## Rerun clustering
  merge_cd4_meta<- merge_cd4@meta.data
  merge_cd4<- RunFullSeurat(merge_cd4@assays$RNA@counts, RunHarmony = TRUE, samples = merge_cd4_meta$sample)
  merge_cd4<- AddMetaData(merge_cd4, merge_cd4_meta[,!colnames(merge_cd4_meta) %in% colnames(merge_cd4@meta.data)])
  
  saveRDS(merge_cd4, file=paste0(analysis_dir, "cd4_seurat_nsclc.glioma.melanoma.Rds"))
```

## Add score for naive, cyto, predys, dys
```{r}
all_markers<- list(cytotoxic= c("CX3CR1", "PRF1", "GZMA", "GZMB", "GZMH",  "FGFBP2","KLRG1", "FCGR3A"),
                   naive=c("TCF7", "CCR7", "SELL", "LEF1"),
                   predysfunctional=c("GZMK", "PDCD1", "CXCR3"),
                   dysfunctional= c("HAVCR2", "GZMB","IFNG", "CXCL13", "TIGIT", "LAYN", "LAG3", 
                                    "PDCD1", "CTLA4", "ITGAE", "ENTPD1")) 
merge_cd8<- AddModuleScore(merge_cd8, all_markers, name = names(all_markers))

## Add max program/maxscore
scores<- merge_cd8@meta.data[,c("cytotoxic1", "naive2", "predysfunctional3", "dysfunctional4")]
scores$max<- apply(scores, 1, function(x){names(x)[which.max(x)]})
scores$maxScore<- apply(scores[,colnames(scores) != "max"], 1, function(x){x[which.max(x)]})
merge_cd8$maxGeneset<- scores$max
merge_cd8$maxGeneset_score<- scores$maxScore
merge_cd8$maxGeneset_lowScore<- ifelse(merge_cd8$maxGeneset_score<0.2, "ScoreTooLow", merge_cd8$maxGeneset)

## Plot
DimPlot(merge_cd8, group.by = "maxGeneset_lowScore")
ggsave(paste0(figure_dir, "UMAP_maxNature2020Score.png"), width=6, height=5)

## Proportion by tumor type
bd<- as.data.frame(table(merge_cd8$maxGeneset_lowScore, merge_cd8$TumorType))
colnames(bd)<- c("Geneset", "TumorType", "NCells")
bd<- bd %>% group_by(TumorType) %>% mutate(perCells=NCells/sum(NCells)) %>% as.data.frame()
ggplot(bd, aes(x=TumorType,y=perCells, fill=Geneset))+
  geom_bar(stat="identity")
ggsave(paste0(figure_dir, "ProportionNature2020_byTumorType.png"), width=4, height=4)

## Expressin of GOI by tumor type + max geneset
merge_cd8$maxGeneset_byTumor<- paste0(merge_cd8$maxGeneset_lowScore, "_", merge_cd8$TumorType)
DotPlot(merge_cd8, group.by = "maxGeneset_byTumor", 
        features=c("CD8A","CD3G", 
                   "PDCD1","CTLA4", "HAVCR2", "ITGAE",
                   "PRF1", "GNLY", "GZMA", 
                   "SELPLG", "KLRB1", "PTGER2"))+
  theme(axis.text.x = element_text(angle=45, hjust=1))
ggsave(paste0(figure_dir, "Dotplot_GOI_byNature2020MaxProgram.png"), width=8, height = 6)
```

## Basic plots
```{r}
merge_cd8<- readRDS(paste0(analysis_dir, "cd8_seurat_nsclc.glioma.melanoma.Rds"))
merge_cd4<- readRDS(paste0(analysis_dir, "cd4_seurat_nsclc.glioma.melanoma.Rds"))
  
## CD8
  ## By glioma/nsclc/melanoma
  DimPlot(merge_cd8, group.by = "TumorType", label=FALSE)
  ggsave(paste0(figure_dir, "UMAP_byTumorType.png"), width=5, height=4.5)
  
  ## By cell type
  DimPlot(merge_cd8, group.by = "cellAnnot")+
    scale_color_manual(values=program_colors)
  ggsave(paste0(figure_dir, "UMAP_byCellType.png"), width=11, height=9)

  
  ## Dotplot of inhibitory GOI by tumor type
  DotPlot(merge_cd8, group.by = "TumorType", 
            features=c("PDCD1", "HAVCR2", "TIGIT", "CTLA4", "GZMK", "ITGAE"))+
      theme(axis.text.x = element_text(angle=45, hjust=1))
  ggsave(paste0(figure_dir, "Dotplot_CD8_InhibitoryGOI_byTumorType.png"), width=6, height=6)
  
  ## Dotplot of  GOI by tumor type
  DotPlot(merge_cd8, group.by = "TumorType", 
            features=c("CD8A", "SELPLG", "PTGER2", "KLRB1"), scale=FALSE)+
      theme(axis.text.x = element_text(angle=45, hjust=1))
  ggsave(paste0(figure_dir, "Dotplot_CD8_GOI_byTumorType.png"), width=5, height=4)
 
  
## CD4
  ## By glioma/nsclc
  DimPlot(merge_cd4, group.by = "TumorType", label=TRUE)+NoLegend()
  ggsave(paste0(figure_dir, "UMAP_CD4_byTumorType.png"), width=5, height=5)
  
  ## By cell type
  DimPlot(merge_cd4, group.by = "cellAnnot")+
    scale_color_manual(values=program_colors[names(program_colors) %in% unique(merge_cd4$cellAnnot)])
  ggsave(paste0(figure_dir, "UMAP_CD4_byCellType.png"), width=10, height=9)
  
  ## Dotplot of GOI
  merge_cd4$cellAnnot_byTumor<- paste0( merge_cd4$cellAnnot, "_", merge_cd4$TumorType)
  DotPlot(merge_cd4, group.by = "cellAnnot_byTumor", 
            features=c("CCR7", "FOXP3", "EOMES", "ANXA1", "CD69",
                     "CXCR1", "PRF1", "GNLY",
                     "GZMK", "ITGAE", "PDCD1", "HAVCR2", "TIGIT", "CTLA4"))+
      theme(axis.text.x = element_text(angle=45, hjust=1))
  ggsave(paste0(figure_dir, "Dotplot_CD4_GOI_byCellType.png"), width=10, height=6)
  



```

## Score all cells for glioma and nsclc gene sets, correlate scores
```{r}
## CD8
  ## Remove Tregs and Inhibitory- cd4 specifc
  glioma_markers<- glioma_markers[!glioma_markers$cluster %in% c("Treg", "Inhibitory"),]
  
  ## Subset markers to top 100 (may be fewer than this) for each program
  glioma_top_markers<- glioma_markers %>% group_by(cluster) %>% top_n(n=100, wt=avg_log2FC) %>% as.data.frame()
  nsclc_top_markers<- nsclc_cd8_markers %>% group_by(Cluster) %>% top_n(n=100, wt=F) %>% as.data.frame()
  
  ## Split into list
  glioma_marker_list<- split(glioma_top_markers, f=glioma_top_markers$cluster)
  glioma_marker_list<- lapply(glioma_marker_list, function(x){x$gene})
  names(glioma_marker_list)<- paste0("Glioma_", names(glioma_marker_list))
  
  nsclc_marker_list<- split(nsclc_top_markers, f=nsclc_top_markers$Cluster)
  nsclc_marker_list<- lapply(nsclc_marker_list, function(x){x$Gene.Symbol})
  names(nsclc_marker_list)<- paste0("NSCLC_", names(nsclc_marker_list))
  all_markers<-c(glioma_marker_list, nsclc_marker_list)
  
  ## Norm/center
  cm_list<-NormCenter(merge_cd8@assays$RNA@counts)
  cm_mean<- rowMeans(log2(cm_list$raw_data+1))
  
  ## Score
  scores<- as.data.frame(t(scoreNmfGenes(cm_list$center_data, cm_mean, all_markers)))
  
  ## Correlate and plot heatmap
  scores_factor_hc = clusterNmfFactors(scores)
  scores_factor_cor = scores_factor_hc$cor_coef[scores_factor_hc$hc_obj$order, scores_factor_hc$hc_obj$order]
  
  ## Heatmap of correlations
  hm_colors = rev((brewer.pal(n=9, name="RdBu")))
  hm_colors = colorRampPalette(colors = hm_colors)
  pheatmap(scores_factor_cor, color = hm_colors(100), 
           cluster_rows = F, cluster_cols = F, 
           annotation_names_row = F, annotation_names_col =T,
           show_rownames = T, show_colnames = F,
           filename = paste0(figure_dir, "Cor_CD8programs_Glioma.vs.NSCLC.png"),
           width = 8, height = 4)
  
  ## Dendrogram of hierarchical clustering 
  jpeg(filename=paste0(figure_dir, "HC_CD8programs_Glioma.vs.NSCLC.png"), width = 400, height = 600)
  plot(scores_factor_hc$hc_obj)
  dev.off()
  
## CD4
  ## Remove cd8-specific markers
  glioma_markers<- glioma_markers[!glioma_markers$cluster %in% c("Cytotoxic","Predysfunctional"),]
  
  ## Subset markers to top 100 (may be fewer than this) for each program
  glioma_top_markers<- glioma_markers %>% group_by(cluster) %>% top_n(n=100, wt=avg_log2FC) %>% as.data.frame()
  nsclc_top_markers<- nsclc_cd4_markers %>% group_by(Cluster) %>% top_n(n=100, wt=F) %>% as.data.frame()
  
  ## Split into list
  glioma_marker_list<- split(glioma_top_markers, f=glioma_top_markers$cluster)
  glioma_marker_list<- lapply(glioma_marker_list, function(x){x$gene})
  names(glioma_marker_list)<- paste0("Glioma_", names(glioma_marker_list))
  
  nsclc_marker_list<- split(nsclc_top_markers, f=nsclc_top_markers$Cluster)
  nsclc_marker_list<- lapply(nsclc_marker_list, function(x){x$Gene.Symbol})
  names(nsclc_marker_list)<- paste0("NSCLC_", names(nsclc_marker_list))
  all_markers<-c(glioma_marker_list, nsclc_marker_list)
  
  ## Norm/center
  cm_list<-NormCenter(merge_cd4@assays$RNA@counts)
  cm_mean<- rowMeans(log2(cm_list$raw_data+1))
  
  ## Score
  scores<- as.data.frame(t(scoreNmfGenes(cm_list$center_data, cm_mean, all_markers)))
  
  ## Correlate and plot heatmap
  scores_factor_hc = clusterNmfFactors(scores)
  scores_factor_cor = scores_factor_hc$cor_coef[scores_factor_hc$hc_obj$order, scores_factor_hc$hc_obj$order]
  
  ## Heatmap of correlations
  hm_colors = rev((brewer.pal(n=9, name="RdBu")))
  hm_colors = colorRampPalette(colors = hm_colors)
  pheatmap(scores_factor_cor, color = hm_colors(100), 
           cluster_rows = F, cluster_cols = F, 
           annotation_names_row = F, annotation_names_col =T,
           show_rownames = T, show_colnames = F,
           filename = paste0(figure_dir, "Cor_CD4programs_Glioma.vs.NSCLC.png"),
           width = 8, height = 4)
  
  ## Dendrogram of hierarchical clustering 
  jpeg(filename=paste0(figure_dir, "HC_CD4programs_Glioma.vs.NSCLC.png"), width = 400, height = 600)
  plot(scores_factor_hc$hc_obj)
  dev.off()
  
```

